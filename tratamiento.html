<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Clínico | Figura Rostro KG</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#4a044e',    /* Morado muy oscuro (casi negro) */
                            main: '#86198f',    /* Fucsia/Morado vibrante */
                            light: '#d946ef',   /* Fucsia claro */
                            soft: '#fdf4ff',    /* Fondo rosado muy pálido */
                        }
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Fondo general suave */
        body { 
            background-color: #fdf4ff; 
            color: #374151; 
        } 
        
        /* ESTILO DE LOS INPUTS (Cuadros de texto) */
        /* Corrección: Bordes más oscuros y definidos como pediste */
        .input-pro {
            background-color: #ffffff;
            border: 1px solid #6b7280; /* Gris oscuro (Gray-500) para definición */
            color: #111827; /* Texto casi negro */
            border-radius: 6px;
            padding: 8px 12px;
            width: 100%;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Efecto al hacer clic en el input */
        .input-pro:focus { 
            outline: none; 
            border-color: #d946ef; /* Se pone fucsia al escribir */
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1);
        }
        
        .input-pro::placeholder { 
            color: #9ca3af; 
            font-weight: 400; 
        }

        /* ETIQUETAS DE TEXTO (Labels) */
        .label-pro {
            font-size: 10px; 
            font-weight: 800; 
            text-transform: uppercase; 
            color: #4a044e; /* Morado oscuro */
            margin-bottom: 4px; 
            display: block; 
            letter-spacing: 0.05em;
        }

        /* FILAS DE LA TABLA DE SERVICIOS */
        .service-row {
            background-color: #ffffff; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            padding: 10px;
            margin-bottom: 8px; 
            display: grid; 
            grid-template-columns: 2fr 2fr 1fr 40px; 
            gap: 10px; 
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* TÍTULOS DE SECCIÓN */
        .section-header {
            font-size: 12px; 
            font-weight: 800; 
            text-transform: uppercase; 
            color: #86198f; /* Fucsia */
            border-bottom: 2px solid #f0abfc; /* Línea suave */
            padding-bottom: 6px; 
            margin-top: 24px; 
            margin-bottom: 16px;
            display: flex; 
            align-items: center; 
            gap: 8px;
        }

        /* CHECKBOX PERSONALIZADO */
        .custom-check { 
            accent-color: #c026d3; 
            width: 16px; 
            height: 16px; 
            cursor: pointer; 
        }

        /* ANIMACIÓN DE CARGA (Loader) */
        .loader { 
            border: 3px solid #f3e8ff; 
            border-top: 3px solid #86198f; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* REGLAS PARA IMPRESIÓN (PDF) */
        @media print {
            body { background-color: white !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .shadow-2xl, .shadow-lg, .shadow-sm { box-shadow: none !important; }
            .border { border: 1px solid #ddd !important; }
            
            /* Forzar que el encabezado morado salga a color en el PDF */
            .header-gradient { 
                background-image: linear-gradient(to right, #4a044e, #701a75, #4a044e) !important; 
                color: white !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
        }
    </style>
</head>
<body class="p-4 flex justify-center min-h-screen">

    <nav class="fixed top-0 inset-x-0 bg-white/95 backdrop-blur shadow-sm p-3 z-50 border-b border-purple-100 no-print">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <a href="/" class="text-brand-dark hover:text-brand-light font-bold text-xs flex items-center gap-1 transition">
                    <i class="fas fa-arrow-left"></i> Volver al Inicio
                </a>
            </div>
            <div class="flex gap-3">
                <button onclick="limpiarFormulario()" class="bg-purple-50 hover:bg-purple-100 text-purple-900 px-4 py-2 rounded-full text-xs font-bold border border-purple-200 transition flex items-center shadow-sm">
                    <i class="fas fa-file-medical mr-2"></i> Nueva Ficha
                </button>
                <button onclick="toggleView('list')" class="bg-brand-main hover:bg-brand-dark text-white px-4 py-2 rounded-full text-xs font-bold transition flex items-center shadow-md shadow-purple-200">
                    <i class="fas fa-database mr-2"></i> Consultar BD
                </button>
            </div>
        </div>
    </nav>
    
    <div class="h-16 no-print"></div>

    <div id="viewForm" class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl border border-purple-100 relative overflow-hidden mb-10">
        
        <div class="header-gradient bg-gradient-to-r from-fuchsia-900 via-purple-800 to-fuchsia-900 p-8 flex justify-between items-start relative">
            
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            
            <div class="relative z-10">
                
                <div class="mb-4">
                    <div class="h-16 w-48 border-2 border-dashed border-white/30 rounded-lg flex items-center justify-center bg-white/5 backdrop-blur-sm">
                        <span class="text-[10px] text-white/70 font-bold tracking-widest text-center">
                            [ LOGO BLANCO AQUÍ ]<br>Reemplazar &lt;img&gt;
                        </span>
                    </div>
                </div>
                <h1 class="text-3xl font-black text-white uppercase tracking-wider drop-shadow-md">Figura Rostro KG</h1>
                <p class="text-fuchsia-200 text-xs font-bold tracking-[0.2em] uppercase mt-2 border-t border-white/20 pt-2 inline-block">
                    Especialistas en Rejuvenecimiento No Invasivo
                </p>
            </div>

            <div class="text-right flex flex-col items-end relative z-10">
                <div class="mb-4 text-purple-100">
                    <p class="text-[10px] uppercase opacity-80 mb-1 font-semibold">Fecha de Emisión</p>
                    <div class="text-white text-sm font-bold bg-black/20 px-3 py-1 rounded" id="fechaHoy"></div>
                </div>
                
                <div class="bg-white text-brand-dark px-4 py-2 rounded-lg shadow-lg border-l-4 border-fuchsia-500">
                    <p class="text-[9px] uppercase text-gray-500 mb-0 font-bold">N° de Solicitud</p>
                    <div class="text-2xl font-black font-mono tracking-widest" id="folioDisplay">...</div>
                </div>
            </div>
        </div>

        <div class="p-8 md:p-10 bg-white relative">
            
            <form id="clinicalForm">
                
                <div class="section-header mt-0">
                    <i class="fas fa-user-circle text-lg"></i> Información del Paciente
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="label-pro">Nombre Completo</label>
                        <input type="text" id="nombre" class="input-pro border-l-4 border-l-brand-main" placeholder="Ej. Ana María Pérez" required>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div>
                            <label class="label-pro">Cédula / ID</label>
                            <input type="text" id="cedula" class="input-pro" placeholder="Ej. 8-123-456">
                        </div>
                        <div>
                            <label class="label-pro">Teléfono</label>
                            <input type="tel" id="telefono" class="input-pro" placeholder="Ej. 6600-1234">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="label-pro">Fecha de Nacimiento</label>
                        <div class="flex gap-3">
                            <select id="dia_nac" class="input-pro w-20 cursor-pointer" onchange="calcularEdad()">
                                <option value="">Día</option>
                                <script>for(let i=1;i<=31;i++) document.write(`<option value="${i}">${i}</option>`);</script>
                            </select>
                            <select id="mes_nac" class="input-pro flex-1 cursor-pointer" onchange="calcularEdad()">
                                <option value="">Mes</option>
                                <option value="1">Enero</option> <option value="2">Febrero</option> <option value="3">Marzo</option>
                                <option value="4">Abril</option> <option value="5">Mayo</option> <option value="6">Junio</option>
                                <option value="7">Julio</option> <option value="8">Agosto</option> <option value="9">Septiembre</option>
                                <option value="10">Octubre</option> <option value="11">Noviembre</option> <option value="12">Diciembre</option>
                            </select>
                            <input type="number" id="anio_nac" class="input-pro w-24" placeholder="Año" onchange="calcularEdad()">
                        </div>
                    </div>
                    <div class="flex gap-5">
                        <div class="w-24">
                            <label class="label-pro">Edad</label>
                            <input type="text" id="edad" class="input-pro bg-purple-50 text-center font-bold text-brand-main" readonly>
                        </div>
                        <div class="flex-1">
                            <label class="label-pro">Ocupación</label>
                            <input type="text" id="ocupacion" class="input-pro">
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <label class="label-pro">Dirección de Habitación</label>
                    <input type="text" id="direccion" class="input-pro" placeholder="Dirección completa...">
                </div>

                <div class="flex justify-between items-end border-b-2 border-purple-100 pb-2 mt-8 mb-4">
                    <div class="section-header border-0 m-0 w-full">
                        <i class="fas fa-spa text-lg"></i> Tratamientos Solicitados
                    </div>
                    <button type="button" onclick="agregarServicio()" class="text-[10px] whitespace-nowrap bg-purple-50 hover:bg-purple-100 text-purple-900 border border-purple-200 px-4 py-2 rounded-full transition no-print font-bold flex items-center shadow-sm">
                        <i class="fas fa-plus text-fuchsia-600 mr-1.5"></i> AGREGAR SERVICIO
                    </button>
                </div>

                <div id="listaServicios" class="mb-10 min-h-[50px]">
                    </div>

                <div class="bg-gradient-to-br from-white to-purple-50 p-6 rounded-2xl border border-purple-200 mb-8 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        
                        <div class="space-y-5">
                            <div class="flex justify-between items-center">
                                <label class="label-pro text-gray-600">Subtotal Servicios</label>
                                <input type="text" id="subtotal" class="input-pro w-40 text-right font-mono bg-white font-bold text-gray-500 border-gray-300" readonly value="$0.00">
                            </div>
                            
                            <hr class="border-purple-100">
                            
                            <div class="flex justify-between items-center">
                                <label class="label-pro text-brand-main">Descuento (%)</label>
                                <div class="flex gap-2 bg-white p-1.5 rounded-lg border border-purple-100 shadow-sm">
                                    <button type="button" onclick="setPromo(0.10)" class="w-10 py-1 text-[10px] rounded hover:bg-purple-100 text-purple-900 font-bold transition border border-gray-100">10%</button>
                                    <button type="button" onclick="setPromo(0.20)" class="w-10 py-1 text-[10px] rounded hover:bg-purple-100 text-purple-900 font-bold transition border border-gray-100">20%</button>
                                    <button type="button" onclick="setPromo(0.30)" class="w-10 py-1 text-[10px] rounded hover:bg-purple-100 text-purple-900 font-bold transition border border-gray-100">30%</button>
                                    <button type="button" onclick="resetDesc()" class="text-[10px] text-red-400 px-2 hover:text-red-600 border-l border-gray-200" title="Quitar"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <input type="hidden" id="promo_pct" value="0">
                            <div class="text-right text-[11px] text-fuchsia-600 font-mono font-bold" id="descuento_txt"></div>

                            <div class="flex justify-between items-center pt-2">
                                <label class="label-pro text-brand-main flex items-center gap-2">
                                    <i class="fas fa-gift opacity-50"></i> Bono Gift Card ($)
                                </label>
                                <input type="number" id="bono_extra" class="input-pro w-40 text-right border-fuchsia-200 focus:border-fuchsia-500 text-fuchsia-700 font-bold" placeholder="0.00" oninput="calcularTotal()">
                            </div>
                        </div>

                        <div class="bg-white p-6 border-2 border-purple-100 rounded-xl shadow-lg flex flex-col justify-between relative overflow-hidden">
                            <div class="absolute -top-10 -right-10 w-32 h-32 bg-fuchsia-100 rounded-full opacity-50 pointer-events-none"></div>

                            <div class="flex justify-between items-end mb-5 relative z-10">
                                <span class="text-xs font-extrabold text-gray-500 uppercase tracking-wider">Total a Pagar</span>
                                <span id="lblTotal" class="text-3xl font-black text-gray-800 font-mono tracking-tight">$0.00</span>
                            </div>
                            
                            <div class="flex justify-between items-center mb-5 bg-green-50 p-3 rounded-lg border border-green-200 relative z-10">
                                <span class="text-[10px] font-bold text-green-800 uppercase flex items-center gap-2">
                                    <i class="fas fa-money-bill-wave"></i> Abono Hoy ($)
                                </span>
                                <input type="number" id="abono" class="w-32 bg-transparent text-right font-black text-xl text-green-700 outline-none placeholder-green-700/20" placeholder="0" oninput="calcularTotal()">
                            </div>

                            <div class="border-t-2 border-dashed border-gray-200 pt-4 flex justify-between items-end relative z-10">
                                <span class="text-[11px] font-bold text-gray-400 uppercase">Saldo Pendiente</span>
                                <span id="lblPendiente" class="text-2xl font-bold text-rose-500 font-mono">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-header"><i class="fas fa-file-contract text-lg"></i> Historial y Consentimiento</div>
                
                <div class="mb-6 bg-white p-5 border border-purple-100 rounded-xl shadow-sm">
                    <p class="label-pro mb-3 text-gray-500">Marque antecedentes relevantes:</p>
                    <div class="flex flex-wrap gap-6 text-[10px] text-gray-700 font-bold uppercase">
                        <label class="flex items-center cursor-pointer hover:text-brand-main transition bg-gray-50 px-2 py-1 rounded border border-gray-100"><input type="checkbox" id="m_diabetes" class="custom-check mr-2"> Diabetes</label>
                        <label class="flex items-center cursor-pointer hover:text-brand-main transition bg-gray-50 px-2 py-1 rounded border border-gray-100"><input type="checkbox" id="m_hipertension" class="custom-check mr-2"> Hipertensión</label>
                        <label class="flex items-center cursor-pointer hover:text-brand-main transition bg-gray-50 px-2 py-1 rounded border border-gray-100"><input type="checkbox" id="m_alergias" class="custom-check mr-2"> Alergias</label>
                        <label class="flex items-center cursor-pointer hover:text-brand-main transition bg-gray-50 px-2 py-1 rounded border border-gray-100"><input type="checkbox" id="m_embarazo" class="custom-check mr-2"> Embarazo</label>
                        <label class="flex items-center cursor-pointer hover:text-brand-main transition bg-gray-50 px-2 py-1 rounded border border-gray-100"><input type="checkbox" id="m_keloides" class="custom-check mr-2"> Keloide</label>
                    </div>
                </div>

                <div class="border-l-[6px] border-brand-light pl-6 py-4 bg-fuchsia-50/30 pr-4 rounded-r-xl text-justify mb-8">
                    <p class="text-[10px] text-gray-600 leading-relaxed mb-4 font-medium">
                        <strong>TÉRMINOS Y CONDICIONES:</strong> El paciente certifica que la información médica provista es verídica y completa. Autoriza a <strong>Figura Rostro KG</strong> a realizar los procedimientos estéticos acordados y consiente el registro fotográfico para el expediente clínico privado. Entiende que los resultados pueden variar según el organismo y exime al establecimiento de responsabilidad por complicaciones derivadas de un cuidado post-tratamiento inadecuado.
                    </p>
                    <label class="flex items-center gap-3 cursor-pointer group bg-white p-3 rounded-lg border border-purple-100 shadow-sm w-fit hover:border-brand-light transition">
                        <input type="checkbox" id="check_legal" class="custom-check group-hover:scale-110 transition"> 
                        <span class="text-[11px] font-extrabold text-gray-800 group-hover:text-brand-main tracking-wide">HE LEÍDO Y ACEPTO LOS TÉRMINOS.</span>
                    </label>
                </div>

                <div class="flex flex-col md:flex-row gap-5 no-print mt-12 border-t border-purple-100 pt-8">
                    <button type="button" id="btnSave" class="flex-1 bg-gradient-to-r from-brand-dark to-brand-main text-white py-4 rounded-xl hover:from-brand-main hover:to-brand-light transition-all duration-300 font-bold shadow-lg shadow-purple-200/50 text-sm flex justify-center items-center gap-3 transform hover:-translate-y-1">
                        <i class="fas fa-cloud-upload-alt text-lg"></i> GUARDAR FICHA
                    </button>
                    <button type="button" id="btnPdf" class="md:w-1/3 bg-white text-brand-dark border-2 border-brand-main/20 py-4 rounded-xl hover:bg-purple-50 hover:border-brand-main transition-all duration-300 font-bold text-sm flex justify-center items-center gap-3 transform hover:-translate-y-1 text-gray-700">
                        <i class="fas fa-print text-lg text-brand-main"></i> IMPRIMIR PDF
                    </button>
                </div>

            </form>
        </div>
    </div>

    <div id="viewList" class="hidden w-full max-w-5xl bg-white shadow-2xl p-8 mt-20 rounded-2xl border border-purple-200 relative overflow-hidden mb-10">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-brand-dark to-brand-light"></div>
        
        <div class="flex justify-between mb-8 border-b border-purple-100 pb-5">
            <div>
                <h2 class="font-extrabold text-2xl text-brand-dark">Base de Datos de Pacientes</h2>
                <p class="text-xs text-fuchsia-600 font-medium mt-1">Registros clínicos almacenados en la nube segura</p>
            </div>
            <button onclick="loadData()" class="text-xs bg-purple-50 px-5 py-2.5 rounded-full hover:bg-purple-100 text-brand-dark font-bold border border-purple-200 transition flex items-center shadow-sm">
                <i class="fas fa-sync-alt mr-2"></i> Actualizar Lista
            </button>
        </div>
        
        <div class="overflow-x-auto rounded-xl border border-purple-100">
            <table class="w-full text-xs text-left text-gray-600">
                <thead class="bg-purple-50 text-brand-dark uppercase font-extrabold tracking-wider">
                    <tr>
                        <th class="p-4 rounded-tl-xl">Folio</th>
                        <th class="p-4">Fecha</th>
                        <th class="p-4">Paciente</th>
                        <th class="p-4">Tratamientos</th>
                        <th class="p-4 text-right">Total</th>
                        <th class="p-4 text-center rounded-tr-xl">Estado</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-purple-50 bg-white"></tbody>
            </table>
        </div>
        
        <div id="loader" class="hidden text-center py-12">
            <div class="loader mx-auto shadow-lg shadow-purple-200"></div>
            <p class="text-xs text-purple-400 mt-3 font-bold animate-pulse">Cargando datos...</p>
        </div>
    </div>

    <script type="module">
        // Importar módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- TUS LLAVES DE FIREBASE (YA CONFIGURADAS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBAuTfBKGuG33c9NXc1s0lkQv-7GwA47l0",
            authDomain: "figurarostro-system.firebaseapp.com",
            projectId: "figurarostro-system",
            storageBucket: "figurarostro-system.firebasestorage.app",
            messagingSenderId: "803848354693",
            appId: "1:803848354693:web:7144490abb18b0319822ec"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colName = "fichas_v3_multi";

        // --- FUNCIONES DE UI Y UTILIDADES ---

        // Generar número de folio aleatorio
        const generarFolio = () => { 
            const random = Date.now().toString().slice(-6); 
            document.getElementById('folioDisplay').innerText = `REQ-${random}`; 
        };

        // Al cargar la página
        document.getElementById('fechaHoy').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        window.addEventListener('load', () => { 
            agregarServicio(); 
            generarFolio(); 
        });

        // Limpiar formulario manual
        window.limpiarFormulario = function() { 
            if(confirm("¿Estás segura de querer iniciar una nueva ficha vacía?")) {
                location.reload(); 
            }
        }

        // Cambiar entre vistas (Formulario <-> Lista)
        window.toggleView = (view) => {
            document.getElementById('viewForm').classList.toggle('hidden', view !== 'form');
            document.getElementById('viewList').classList.toggle('hidden', view !== 'list');
            if(view === 'list') loadData();
        };

        // --- LÓGICA DE SERVICIOS (FILAS DINÁMICAS) ---
        window.agregarServicio = function() {
            const container = document.getElementById('listaServicios'); 
            const id = Date.now(); // ID único para la fila
            const html = `
                <div class="service-row" id="row-${id}">
                    <div>
                        <select class="input-pro bg-purple-50/30 cursor-pointer s-type font-bold text-brand-dark border-purple-200" onchange="checkZone(this)">
                            <option value="Plasma Fibroblast">Plasma Fibroblast</option>
                            <option value="Limpieza Facial">Limpieza Facial</option>
                            <option value="Dermapen">Dermapen</option>
                            <option value="Hidratación">Hidratación</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <input type="text" class="input-pro s-zone" placeholder="Ej. Párpados">
                    </div>
                    <div>
                        <input type="number" class="input-pro text-right font-bold s-price text-gray-800" placeholder="0.00" oninput="calcularTotal()">
                    </div>
                    <div class="text-center pt-1">
                        <button type="button" onclick="eliminarServicio('${id}')" class="text-gray-400 hover:text-rose-500 transition bg-white rounded-full p-1.5 shadow-sm border border-transparent hover:border-rose-200">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        window.eliminarServicio = function(id) { 
            if(document.querySelectorAll('.service-row').length > 1) { 
                document.getElementById(`row-${id}`).remove(); 
                calcularTotal(); 
            } else {
                alert("Debes mantener al menos un servicio.");
            }
        }

        // Activar/Desactivar campo de Zona según tratamiento
        window.checkZone = function(select) {
            const input = select.closest('.service-row').querySelector('.s-zone');
            if(!select.value.includes('Fibroblast') && !select.value.includes('Otro')) { 
                input.value = ''; 
                input.placeholder = '-'; 
                input.disabled = true; 
                input.style.backgroundColor = '#f3f4f6'; 
                input.style.borderColor = '#e5e7eb'; 
            } else { 
                input.placeholder = 'Especifique zona'; 
                input.disabled = false; 
                input.style.backgroundColor = '#fff'; 
                input.style.borderColor = '#6b7280'; 
            }
        }

        // --- CÁLCULOS MATEMÁTICOS ---
        window.setPromo = (pct) => { document.getElementById('promo_pct').value = pct; calcularTotal(); }
        window.resetDesc = () => { document.getElementById('promo_pct').value = 0; calcularTotal(); }

        window.calcularTotal = function() {
            let sub = 0; 
            // Sumar todas las filas
            document.querySelectorAll('.s-price').forEach(i => sub += parseFloat(i.value) || 0);
            
            const pct = parseFloat(document.getElementById('promo_pct').value) || 0; 
            const desc = sub * pct;
            const bono = parseFloat(document.getElementById('bono_extra').value) || 0;
            
            const total = sub - desc - bono; 
            const abono = parseFloat(document.getElementById('abono').value) || 0; 
            const pend = total - abono;

            // Renderizar en pantalla
            document.getElementById('subtotal').value = "$" + sub.toFixed(2);
            document.getElementById('descuento_txt').innerText = desc > 0 ? `- $${desc.toFixed(2)} (${pct*100}%)` : "";
            document.getElementById('lblTotal').innerText = "$" + total.toFixed(2);
            
            const elPend = document.getElementById('lblPendiente'); 
            elPend.innerText = "$" + pend.toFixed(2);
            
            // Cambiar color si está pagado
            if(pend <= 0.1 && total > 0) {
                elPend.innerText = "PAGADO";
                elPend.className = "text-2xl font-black text-green-600 font-mono tracking-tighter";
            } else {
                elPend.className = "text-2xl font-black text-rose-600 font-mono tracking-tighter";
            }
        }

        // Calcular edad automáticamente
        window.calcularEdad = function() {
            const d = document.getElementById('dia_nac').value, m = document.getElementById('mes_nac').value, y = document.getElementById('anio_nac').value;
            if(d && m && y && y.length===4) { 
                const hoy=new Date(), cumple=new Date(y, m-1, d); 
                let edad=hoy.getFullYear()-cumple.getFullYear(); 
                if(hoy < new Date(hoy.getFullYear(), m-1, d)) edad--; 
                document.getElementById('edad').value = edad + " años"; 
            }
        }

        // --- GUARDAR DATOS (CREATE) ---
        document.getElementById('btnSave').addEventListener('click', async () => {
            const btn = document.getElementById('btnSave'); 
            const nombre = document.getElementById('nombre').value; 
            const folio = document.getElementById('folioDisplay').innerText; 
            const legal = document.getElementById('check_legal').checked;

            if(!nombre) return alert("⚠️ Error: Falta el Nombre del Paciente"); 
            if(!legal) return alert("⚠️ Error: Debes aceptar los Términos y Condiciones");

            // Recopilar servicios
            let lista = []; 
            document.querySelectorAll('.service-row').forEach(r => { 
                lista.push({ 
                    tipo: r.querySelector('.s-type').value, 
                    zona: r.querySelector('.s-zone').value, 
                    precio: r.querySelector('.s-price').value 
                }); 
            });

            // Estado de carga
            const originalText = btn.innerHTML; 
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin text-xl"></i> GUARDANDO...'; 
            btn.disabled = true;

            try {
                await addDoc(collection(db, colName), {
                    folio: folio,
                    paciente: { 
                        nombre: nombre, 
                        cedula: document.getElementById('cedula').value, 
                        telefono: document.getElementById('telefono').value, 
                        nacimiento: `${document.getElementById('dia_nac').value}/${document.getElementById('mes_nac').value}/${document.getElementById('anio_nac').value}`, 
                        edad: document.getElementById('edad').value, 
                        ocupacion: document.getElementById('ocupacion').value, 
                        direccion: document.getElementById('direccion').value 
                    },
                    servicios: lista,
                    finanzas: { 
                        subtotal: document.getElementById('subtotal').value, 
                        descuento: document.getElementById('descuento_txt').innerText, 
                        bono: document.getElementById('bono_extra').value, 
                        total: document.getElementById('lblTotal').innerText, 
                        abono: document.getElementById('abono').value, 
                        pendiente: document.getElementById('lblPendiente').innerText 
                    },
                    medico: { 
                        diabetes: document.getElementById('m_diabetes').checked, 
                        hipertension: document.getElementById('m_hipertension').checked, 
                        alergias: document.getElementById('m_alergias').checked, 
                        embarazo: document.getElementById('m_embarazo').checked, 
                        keloides: document.getElementById('m_keloides').checked 
                    },
                    fecha: Timestamp.now()
                });
                
                alert("✅ FICHA GUARDADA EXITOSAMENTE"); 
                
                // Cambiar botón a verde
                btn.innerHTML = '<i class="fas fa-check-circle text-xl"></i> GUARDADO (Listo para PDF)';
                btn.classList.remove('from-brand-dark', 'to-brand-main'); 
                btn.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-default');
                
            } catch (e) { 
                console.error(e); 
                alert("Error al guardar: " + e.message); 
                btn.innerHTML = originalText; 
                btn.disabled = false; 
            }
        });

        // --- CARGAR DATOS (READ) ---
        window.loadData = async () => {
            const tb = document.getElementById('tableBody'); 
            const loader = document.getElementById('loader'); 
            tb.innerHTML=''; 
            loader.classList.remove('hidden');
            
            const snap = await getDocs(query(collection(db, colName), orderBy("fecha", "desc"))); 
            loader.classList.add('hidden');
            
            snap.forEach(doc => { 
                const d = doc.data(); 
                let servs = d.servicios.map(s => `${s.tipo}`).join(', ');
                
                tb.innerHTML += `
                    <tr class="hover:bg-purple-50 transition border-b border-purple-100">
                        <td class="p-4 font-mono font-bold text-brand-main">${d.folio || 'N/A'}</td>
                        <td class="p-4 text-gray-500">${d.fecha.toDate().toLocaleDateString()}</td>
                        <td class="p-4 font-bold text-gray-800">${d.paciente.nombre}</td>
                        <td class="p-4 text-xs text-gray-500 max-w-[200px] truncate">${servs}</td>
                        <td class="p-4 text-right font-mono font-bold">${d.finanzas.total}</td>
                        <td class="p-4 text-center">
                            ${d.finanzas.pendiente.includes('PAGADO') 
                                ? '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-extrabold shadow-sm">PAGADO</span>' 
                                : '<span class="bg-rose-100 text-rose-700 px-3 py-1 rounded-full text-[10px] font-extrabold shadow-sm">PENDIENTE</span>'}
                        </td>
                    </tr>`;
            });
        };

        // --- GENERAR PDF ---
        document.getElementById('btnPdf').addEventListener('click', () => {
            const el = document.getElementById('viewForm'); 
            // Ocultar elementos que no deben salir en el papel
            const controls = document.querySelectorAll('.no-print, .btn-remove'); 
            controls.forEach(e => e.style.display = 'none');

            // Configuración del PDF
            html2pdf().set({ 
                margin: 0, 
                filename: `Solicitud_${document.getElementById('folioDisplay').innerText}.pdf`, 
                image: { type: 'jpeg', quality: 1 }, 
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            }).from(el).save().then(() => { 
                // Volver a mostrar botones
                controls.forEach(e => e.style.display = ''); 
            });
        });
    </script>
</body>
</html>
