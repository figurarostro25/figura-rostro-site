<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KG Sistema Cl√≠nico | Admin Seguro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { brand: { dark: '#0f766e', main: '#14b8a6', light: '#ccfbf1', accent: '#0ea5e9' } } } }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; color: #334155; -webkit-font-smoothing: antialiased; transition: background 0.3s; overflow-x: hidden; }
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        
        .paper-sheet { width: 100%; max-width: 230mm; min-height: 297mm; padding: 20px; background-color: white; margin: 0 auto; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; position: relative; border-radius: 12px; }
        .dark .paper-sheet { background-color: #1e293b; border-color: #334155; }
        
        .input-pro { width: 100%; border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; border: 1px solid #cbd5e1; background-color: #f8fafc; outline: none; transition: 0.2s; }
        .dark .input-pro { background-color: #334155; border-color: #475569; color: white; }
        .input-pro:focus { border-color: #14b8a6; ring: 2px ring-teal-100; }
        .input-pro:disabled { background-color: #f1f5f9; opacity: 0.7; color: #64748b; font-weight: 700; cursor: not-allowed; }
        
        .label-pro { display: block; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-bottom: 0.3rem; color: #475569; letter-spacing: 0.05em; }
        .dark .label-pro { color: #94a3b8; }
        
        .section-header { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: 800; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; color: #0f766e; padding-bottom: 0.5rem; margin-top: 1.5rem; margin-bottom: 1rem; }
        .nav-btn-active { background-color: #0f766e; color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .quick-btn { font-size: 10px; font-weight: 800; padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; cursor: pointer; color: #334155; }
        .dark .quick-btn { background: #334155; border-color: #475569; color: white; }
        
        .service-row { display: grid; gap: 0.5rem; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; background-color: #fff; grid-template-columns: 2fr 1fr 80px 40px; margin-bottom: 0.75rem; }
        .dark .service-row { background-color: #1e293b; border-color: #475569; }

        /* ‚úÖ Para que ‚ÄúVALORACION...‚Äù NO se corte */
        .line-clamp-2{
            display:-webkit-box;
            -webkit-box-orient:vertical;
            -webkit-line-clamp:2;
            overflow:hidden;
        }

        @media (max-width: 768px) {
            .service-row { grid-template-columns: 1fr; }
            .paper-sheet { border-radius: 0; padding: 15px; }
            .nav-text { display: none; }
        }
        
        @media print { .no-print { display: none !important; } .paper-sheet { box-shadow: none !important; border: none !important; margin: 0 !important; width: 100% !important; padding: 10mm !important; } }
    </style>
</head>
<body class="p-0 pt-20 md:p-4 md:pt-24">

    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-slate-900 flex items-center justify-center transition-all duration-500">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-slate-700 mx-4">
            <div class="mb-6 flex justify-center">
                <div class="w-16 h-16 bg-teal-600 rounded-xl flex items-center justify-center text-white text-2xl font-black italic shadow-lg">KG</div>
            </div>
            <h2 class="text-2xl font-black uppercase text-slate-800 dark:text-white mb-2 italic">Acceso Restringido</h2>
            <p class="text-xs text-slate-400 mb-6 uppercase tracking-widest font-bold">Sistema Administrativo</p>
            
            <form id="loginForm" class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block">Correo Autorizado</label>
                    <input type="email" id="loginEmail" class="input-pro border-slate-300 dark:border-slate-600 shadow-inner" placeholder="usuario@figurarostro.com" required>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-1 block">Contrase√±a</label>
                    <input type="password" id="loginPass" class="input-pro border-slate-300 dark:border-slate-600 shadow-inner" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <p id="loginError" class="text-rose-500 text-xs font-bold text-center hidden"></p>
                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-500 text-white py-4 rounded-xl font-black uppercase shadow-lg transition-all active:scale-95 text-sm italic">
                    <i class="fas fa-lock mr-2"></i> Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>

    <nav class="fixed top-0 inset-x-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md shadow-md p-3 z-50 border-b border-slate-200 dark:border-slate-700 no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center px-2">
            <div class="flex items-center gap-3">
                <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500">
                    <i class="fas fa-moon dark:hidden text-sm"></i><i class="fas fa-sun hidden dark:inline text-amber-400 text-sm"></i>
                </button>
                <div class="flex items-center gap-1 font-black italic text-slate-800 dark:text-white uppercase tracking-tighter text-sm">
                    <div class="w-7 h-7 bg-teal-600 rounded text-white flex items-center justify-center text-xs">KG</div>
                    <span class="hidden xs:inline">Figura Rostro</span>
                </div>
            </div>
            
            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl border dark:border-slate-700">
                <button onclick="toggleView('form')" id="navForm" class="nav-btn-active px-4 py-2 text-[10px] font-bold">FICHA</button>
                <button onclick="toggleView('list')" id="navList" class="px-4 py-2 text-[10px] font-bold dark:text-slate-400">PACIENTES</button>
                <button onclick="toggleView('appointments')" id="navAppts" class="px-4 py-2 text-[10px] font-bold dark:text-slate-400">CITAS</button>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="logout()" class="w-9 h-9 rounded-full bg-rose-50 dark:bg-rose-900/30 text-rose-500 flex items-center justify-center shadow-sm" title="Cerrar Sesi√≥n">
                    <i class="fas fa-sign-out-alt text-sm"></i>
                </button>
                <button onclick="toggleAlerts()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center relative">
                    <i class="fas fa-bell text-slate-500 dark:text-slate-400 text-sm"></i>
                    <span id="alertCount" class="absolute -top-1 -right-1 bg-rose-500 text-white text-[8px] font-black w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <button onclick="limpiarFormulario()" class="bg-rose-500 text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg"><i class="fas fa-plus text-sm"></i></button>
            </div>
        </div>
    </nav>

    <div id="alertBox" class="fixed top-16 right-4 w-72 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl shadow-2xl hidden z-[60] p-4 no-print animate-fade-in">
        <p class="text-[10px] font-black uppercase text-slate-400 mb-2 border-b pb-1 text-left">Notificaciones Sistema</p>
        <div id="alertList" class="space-y-2 max-h-64 overflow-y-auto"></div>
    </div>

    <div id="seccionFormulario" class="px-2 md:px-0">
        <div id="editModeBanner" class="hidden max-w-5xl mx-auto mb-4 bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 p-4 rounded-xl flex justify-between items-center no-print">
            <span class="font-bold text-amber-800 dark:text-amber-400 text-xs text-left">MODO EDICI√ìN: Folio <span class="folio-display font-mono"></span></span>
            <button onclick="limpiarFormulario()" class="text-[10px] font-black underline uppercase">Salir</button>
        </div>

        <div id="printContainer">
            <div id="page1" class="paper-sheet mb-4 text-left">
                <div class="bg-slate-900 rounded-xl p-6 md:p-10 flex justify-between items-start text-white mb-6">
                    <div class="text-left">
                        <h1 class="text-xl md:text-2xl font-black uppercase tracking-widest">Figura Rostro KG</h1>
                        <p class="text-teal-400 text-[10px] font-bold uppercase tracking-widest">Est√©tica & Plasma Fibroblast</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[8px] font-bold opacity-70 uppercase">Expediente N¬∫</p>
                        <div class="text-lg font-mono font-black folio-display">---</div>
                    </div>
                </div>

                <div class="section-header text-teal-800 border-teal-100 italic">DATOS PERSONALES</div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                    <div class="md:col-span-5"><label class="label-pro">Nombre Completo *</label><input type="text" id="nombre" class="input-pro border-l-4 border-teal-500 shadow-sm"></div>
                    <div class="md:col-span-4"><label class="label-pro text-purple-600">Email (App Cliente)</label><input type="email" id="email_paciente" class="input-pro shadow-inner border-purple-100" placeholder="cliente@gmail.com"></div>
                    <div class="md:col-span-3"><label class="label-pro">WhatsApp *</label><input type="tel" id="telefono" class="input-pro shadow-sm"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                    <div class="md:col-span-3"><label class="label-pro">C√©dula</label><input type="text" id="cedula" class="input-pro"></div>
                    <div class="md:col-span-6 text-left">
                        <label class="label-pro">Nacimiento</label>
                        <div class="flex gap-1">
                            <select id="dia_nac" class="input-pro w-16" onchange="calcularEdad()"><option value="">D</option><script>for(let i=1;i<=31;i++) document.write(`<option value="${i}">${i}</option>`);</script></select>
                            <select id="mes_nac" class="input-pro flex-1" onchange="calcularEdad()"><option value="">Mes</option><option value="1">Ene</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Abr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Ago</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dic</option></select>
                            <input type="number" id="anio_nac" class="input-pro w-20" placeholder="A√±o" onchange="calcularEdad()">
                        </div>
                    </div>
                    <div class="md:col-span-3"><label class="label-pro">Edad</label><input type="text" id="edad" class="input-pro bg-teal-50 dark:bg-slate-700 font-bold text-center text-teal-700 dark:text-teal-400" readonly></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="text-left"><label class="label-pro">Ocupaci√≥n / Profesi√≥n</label><input type="text" id="ocupacion" class="input-pro"></div>
                    <div class="text-left"><label class="label-pro">Direcci√≥n Residencia</label><input type="text" id="direccion" class="input-pro"></div>
                </div>

                <div class="section-header text-teal-800 border-teal-100 italic">PLAN DE TRATAMIENTO</div>
                <div id="listaServicios" class="mb-4 space-y-2"></div>
                <button type="button" onclick="agregarServicio()" class="text-[10px] font-black bg-slate-100 dark:bg-slate-800 border px-5 py-3 rounded-xl no-print uppercase hover:bg-slate-200 transition-all">+ AGREGAR ITEM</button>

                <div class="mt-8 bg-slate-50 dark:bg-slate-800/50 p-6 md:p-8 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                        <div class="md:col-span-5 space-y-6 text-left">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="label-pro text-teal-700 font-black italic">Promoci√≥n (%)</label>
                                    <div class="flex gap-1 no-print">
                                        <button type="button" onclick="setDescuento(10)" class="quick-btn">-10%</button>
                                        <button type="button" onclick="setDescuento(20)" class="quick-btn">-20%</button>
                                        <button type="button" onclick="setDescuento(30)" class="quick-btn">-30%</button>
                                    </div>
                                </div>
                                <input type="number" id="descuento_pct" class="input-pro text-lg font-bold" placeholder="0" oninput="calcularTotal()">
                            </div>
                            <div>
                                <label class="label-pro text-teal-700 font-black italic">Bono Bienvenida ($)</label>
                                <div class="flex gap-2 mb-2 no-print">
                                    <button type="button" onclick="setBono(10)" class="quick-btn">$10</button>
                                    <button type="button" onclick="setBono(15)" class="quick-btn">$15</button>
                                </div>
                                <input type="number" id="bono_manual" class="input-pro text-lg font-bold text-teal-600" oninput="calcularTotal()" value="0">
                            </div>
                            <div class="p-4 bg-white dark:bg-slate-700 rounded-2xl border border-dashed border-emerald-200 text-center shadow-inner">
                                <label class="label-pro text-emerald-600 font-black mb-2 italic">Abonos R√°pidos (%)</label>
                                <div class="flex gap-1 mb-3 no-print justify-center">
                                    <button type="button" onclick="aplicarPctAbono(10)" class="quick-btn border-emerald-100">10%</button>
                                    <button type="button" onclick="aplicarPctAbono(30)" class="quick-btn border-emerald-100">30%</button>
                                    <button type="button" onclick="aplicarPctAbono(50)" class="quick-btn border-emerald-100">50%</button>
                                </div>
                                <button type="button" onclick="abrirModalPago()" class="bg-emerald-600 text-white w-full py-4 rounded-xl font-black shadow-lg hover:bg-emerald-700 transition-all uppercase text-xs italic">
                                    <i class="fas fa-plus-circle mr-2"></i> REGISTRAR COBRO
                                </button>
                            </div>
                        </div>

                        <div class="md:col-span-7 text-right flex flex-col justify-end">
                            <div id="desgloseVisual" class="mb-4 text-[1rem] font-bold text-slate-400 space-y-2 uppercase italic">
                                <div class="flex justify-between border-b dark:border-slate-700 pb-1"><span>SUBTOTAL SERVICIOS:</span> <span id="sub_txt" class="text-slate-600 dark:text-slate-300 font-black">$0.00</span></div>
                                <div class="flex justify-between border-b dark:border-slate-700 pb-1 text-rose-400"><span>DESCUENTO PROMO:</span> <span id="desc_txt" class="font-black">-$0.00</span></div>
                                <div class="flex justify-between border-b dark:border-slate-700 pb-1 text-teal-500"><span>BONO BIENVENIDA:</span> <span id="bono_txt" class="font-black">-$0.00</span></div>
                            </div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Final a Pagar</span>
                            <div id="lblTotal" class="text-4xl font-black text-slate-900 dark:text-white tracking-tighter italic uppercase">$0.00</div>
                            
                            <div class="grid grid-cols-2 gap-3 mt-8">
                                <div class="bg-white dark:bg-slate-700 p-3 rounded-xl border shadow-sm text-center">
                                    <label class="text-[9px] font-black text-slate-500 block uppercase mb-1 italic">Total Cobrado</label>
                                    <input type="number" id="abono_anterior" class="w-full bg-transparent font-black text-emerald-600 text-center outline-none text-xl" value="0" readonly>
                                </div>
                                <div class="bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-xl border border-emerald-100 text-center">
                                    <label class="text-[9px] font-black text-emerald-600 block italic mb-1 uppercase text-center">Hoy (+)</label>
                                    <div id="pagoHoyVisual" class="text-2xl font-black text-emerald-700 dark:text-emerald-400 italic">$0.00</div>
                                    <input type="hidden" id="abono_nuevo" value="0">
                                </div>
                            </div>
                            <div class="flex justify-between items-end mt-4 pt-4 border-t-2 border-slate-200">
                                <span class="text-[11px] font-black text-slate-400 uppercase italic">Saldo Pendiente Real:</span>
                                <span id="lblPendiente" class="text-3xl font-black text-rose-500 font-mono tracking-tighter italic">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page2" class="paper-sheet page-break">
                <div class="p-4 md:p-10 text-left">
                    <div class="section-header mt-0 text-slate-800 border-slate-200 uppercase tracking-widest italic">Acuerdos de Cobro y Legales</div>
                    
                    <div class="mb-10 p-6 bg-slate-50 dark:bg-slate-800/30 border-2 border-dashed border-slate-200 rounded-3xl relative">
                        <label class="flex items-center gap-4 mb-4 cursor-pointer no-print group">
                            <input type="checkbox" id="usa_cuotas" class="w-6 h-6 accent-rose-500 rounded" onchange="toggleCuotas()">
                            <span class="font-black text-rose-600 uppercase text-xs">Habilitar Plan de Cuotas Diferidas</span>
                        </label>
                        
                        <div id="cuotasContainer" class="hidden space-y-6 border-t pt-6 text-left">
                            <div id="planPactadoDisplay" class="hidden bg-emerald-50 dark:bg-slate-700 p-4 rounded-xl border-l-4 border-emerald-500 mb-4 shadow-sm">
                                 <p class="text-[10px] font-black uppercase text-emerald-600 mb-1 italic text-left">Acuerdo Original (Bloqueado):</p>
                                 <div id="txtPlanPactado" class="text-sm font-black text-slate-700 dark:text-white uppercase italic text-left"></div>
                            </div>

                            <div id="planEditableUI" class="flex flex-col md:flex-row gap-6 items-center">
                                <div class="w-full md:w-1/3">
                                    <label class="label-pro italic">Dividir en:</label>
                                    <select id="num_cuotas" class="input-pro font-black h-12" onchange="generarCamposFechas()">
                                        <option value="2">2 Cuotas</option><option value="3">3 Cuotas</option><option value="4">4 Cuotas</option>
                                    </select>
                                </div>
                                <div class="w-full md:flex-1">
                                    <label class="label-pro italic">Monto por Cuota:</label>
                                    <div id="desgloseCuotas" class="p-3 bg-white dark:bg-slate-700 rounded border font-mono text-xl font-black text-rose-600 shadow-inner text-center italic uppercase"></div>
                                </div>
                            </div>
                            <div id="camposFechas" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 text-left">
                        <div><label class="label-pro font-black text-rose-600 italic uppercase">Fecha Inicio Procedimiento *</label><input type="date" id="fecha_inicio_real" class="input-pro border-rose-300 shadow-inner"></div>
                        <div><label class="label-pro italic uppercase text-left">Pr√≥ximo Cobro (Vencimiento)</label><input type="text" id="fecha_proximo_pago_auto" class="input-pro bg-slate-50 dark:bg-slate-700 font-bold" readonly placeholder="No definido"></div>
                    </div>

                    <div class="mb-6 text-left"><label class="label-pro italic uppercase">Observaciones Cl√≠nicas / Seguimiento</label><textarea id="observaciones" rows="4" class="input-pro text-xs resize-none shadow-inner" placeholder="Escriba el avance..."></textarea></div>

                    <div id="seccionHistorial" class="mb-8 p-4 bg-slate-50 dark:bg-slate-800/40 rounded-2xl border border-slate-200 shadow-inner">
                        <p class="label-pro mb-3 text-teal-700 italic border-b pb-1 font-black uppercase tracking-widest text-left">Historial de Transacciones Registradas</p>
                        <div id="listaHistorial" class="text-[10px] space-y-2"></div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-800/30 p-8 rounded-3xl border-2 border-slate-100 mb-10 text-left">
                        <h3 class="text-[11px] font-black uppercase mb-4 text-slate-800 dark:text-slate-300 border-b-2 border-white pb-2 italic text-left">Consentimiento Informado y Protecci√≥n de Datos (Panam√°)</h3>
                        <div class="text-[10px] text-justify text-slate-600 dark:text-slate-400 leading-relaxed max-h-64 overflow-y-auto mb-6 border-b border-white pb-4 pr-3">
                            <p class="mb-3"><strong>1. NATURALEZA DEL TRATAMIENTO:</strong> Entiendo que los procedimientos de Figura Rostro KG (Plasma Fibroblast, Hidroplasia, etc.) son de car√°cter est√©tico progresivo y los resultados definitivos dependen de factores biol√≥gicos individuales como el metabolismo, la edad y el tipo de piel de cada paciente.</p>
                            <p class="mb-3"><strong>2. POL√çTICA DE NO RETRACTO:</strong> Todo abono o pago realizado NO es reembolsable ni transferible. Estos montos garantizan la reserva de la agenda, el bloqueo del personal t√©cnico y la preparaci√≥n personalizada de insumos est√©riles necesarios para su tratamiento.</p>
                            <p class="mb-3"><strong>3. LEY 81 PROTECCI√ìN DE DATOS:</strong> Autorizo el tratamiento confidencial de mis datos cl√≠nicos seg√∫n las leyes de la Rep√∫blica de Panam√°. Doy mi consentimiento para la toma de registros visuales (fotos/video) para fines de expediente cl√≠nico y material promocional de la cl√≠nica.</p>
                            <p><strong>4. RESPONSABILIDAD:</strong> Es mi total responsabilidad seguir estrictamente las pautas de higiene y protecci√≥n solar indicadas por el especialista. La cl√≠nica se exime de responsabilidad por negligencia en el cuidado posterior.</p>
                        </div>
                        <label class="flex items-center gap-3 no-print cursor-pointer p-4 bg-teal-50 dark:bg-teal-900/20 border border-teal-100 rounded-2xl shadow-sm text-left transition-all hover:bg-teal-100">
                            <input type="checkbox" id="check_legal" class="w-6 h-6 accent-teal-600">
                            <span class="text-[11px] font-black text-teal-900 dark:text-teal-400 uppercase italic text-left">He le√≠do, comprendo y acepto los t√©rminos legales y consentimiento.</span>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-10 mt-16 text-center">
                        <div>
                            <div class="border-b-2 border-slate-400 h-24 flex items-center justify-center"><canvas id="signaturePad" class="w-full h-full cursor-crosshair"></canvas></div>
                            <p class="text-[10px] font-bold uppercase mt-2 italic text-slate-400">Firma del Paciente</p>
                        </div>
                        <div class="flex flex-col justify-end">
                             <input type="text" id="specialistName" class="w-full text-center border-b-2 border-slate-300 text-sm font-black pb-2 bg-transparent outline-none uppercase italic" placeholder="Firma Especialista">
                             <p class="text-[10px] font-bold uppercase mt-2 italic text-slate-400 tracking-widest text-center">Certificado Figura Rostro KG</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-5xl mx-auto flex flex-col md:flex-row gap-4 no-print mb-24 px-4 mt-10">
            <button id="btnSave" class="flex-1 bg-slate-900 text-white py-5 rounded-xl font-black uppercase text-sm shadow-xl active:scale-95 transition-all"><i class="fas fa-save mr-3 text-teal-400"></i> GUARDAR EXPEDIENTE</button>
            <button id="btnPdf" class="bg-white border-2 border-slate-200 text-slate-700 px-10 py-5 rounded-xl font-black uppercase shadow-lg hover:bg-slate-50 transition-all"><i class="fas fa-file-pdf mr-3 text-rose-500"></i> DESCARGAR PDF</button>
        </div>
    </div>

    <div id="seccionBaseDatos" class="hidden w-full max-w-7xl mx-auto bg-white dark:bg-slate-900 shadow-2xl p-4 md:p-8 rounded-3xl border dark:border-slate-700 no-print mb-32">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h2 class="font-black text-2xl uppercase tracking-tighter text-teal-700 italic text-left"><i class="fas fa-users mr-3"></i> Historial Cl√≠nico</h2>
            <input type="text" id="buscador" placeholder="Buscar paciente..." class="input-pro w-full md:w-80 border-teal-100 shadow-inner uppercase" onkeyup="filtrarTabla()">
        </div>

        <div class="flex flex-wrap gap-2 mb-4 border-b border-slate-100 dark:border-slate-800 pb-4">
            <button onclick="filtrarFinanzas('todos')" id="tabTodos" class="px-5 py-2 text-[10px] font-black uppercase rounded-lg bg-slate-800 text-white shadow-md transition-all">
                Todos
            </button>
            <button onclick="filtrarFinanzas('deuda')" id="tabDeuda" class="px-5 py-2 text-[10px] font-black uppercase rounded-lg bg-white dark:bg-slate-700 text-slate-500 hover:bg-rose-50 hover:text-rose-500 border border-slate-200 dark:border-slate-600 transition-all">
                <i class="fas fa-circle text-[8px] mr-2 text-rose-500"></i> Con Saldo Pendiente
            </button>
            <button onclick="filtrarFinanzas('aldia')" id="tabAldia" class="px-5 py-2 text-[10px] font-black uppercase rounded-lg bg-white dark:bg-slate-700 text-slate-500 hover:bg-emerald-50 hover:text-emerald-500 border border-slate-200 dark:border-slate-600 transition-all">
                <i class="fas fa-check-circle text-[8px] mr-2 text-emerald-500"></i> Pagados / Al d√≠a
            </button>
        </div>

        <div id="tableContainer" class="border overflow-hidden rounded-xl bg-white dark:bg-slate-800 shadow-sm overflow-x-auto">
            <table class="w-full text-xs text-left min-w-[600px]">
                <thead class="bg-slate-800 text-white font-black uppercase sticky top-0">
                    <tr>
                        <th class="p-4">Folio</th><th>Paciente</th><th>Ocupaci√≥n</th><th class="text-right">Total</th><th class="text-right text-emerald-400">Cobrado</th><th class="text-right text-rose-400">Saldo</th><th class="p-4 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
            </table>
        </div>
    </div>

    <div id="seccionCitas" class="hidden w-full max-w-6xl mx-auto bg-white dark:bg-slate-900 shadow-2xl p-6 md:p-8 rounded-3xl border dark:border-slate-700 no-print mb-32 min-h-[600px]">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-800 pb-4 gap-4">
            <div>
                <h2 class="text-xl font-black uppercase italic text-slate-800 dark:text-white">
                    <i class="far fa-calendar-alt mr-2 text-teal-500"></i> Agenda Pro
                </h2>
                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-[0.2em]">Gesti√≥n Inteligente de Pacientes</p>
            </div>
            <div class="flex items-center gap-2 relative">
                <button onclick="toggleCitasFeed()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center relative border border-slate-200 dark:border-slate-700" title="Nuevas reservas">
                    <i id="citasBellIcon" class="fas fa-bell text-slate-600 dark:text-slate-300 text-sm"></i>
                    <span id="citasNewCount" class="absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-black w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <div id="citasFeed" class="hidden absolute right-0 top-12 w-[340px] max-w-[90vw] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl z-[200] overflow-hidden">
                    <div class="p-3 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between">
                        <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Notificaciones de Reservas</p>
                        <button onclick="clearCitasFeed()" class="text-[10px] font-black text-rose-500 uppercase underline">Limpiar</button>
                    </div>
                    <div id="citasFeedList" class="max-h-[320px] overflow-y-auto p-3 space-y-2"></div>
                    <div class="p-3 border-t border-slate-100 dark:border-slate-700 text-center">
                        <button onclick="toggleCitasFeed()" class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold text-[10px] uppercase">Cerrar</button>
                    </div>
                </div>
                <button onclick="refreshCitas()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700" title="Refrescar">
                    <i class="fas fa-rotate-right text-slate-600 dark:text-slate-300 text-sm"></i>
                </button>
                <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                    <button onclick="filtrarVistaCitas('pendientes')" id="tabPendientes" class="px-5 py-2 rounded-md text-[10px] font-black uppercase transition-all bg-white dark:bg-slate-700 shadow-sm text-teal-700 dark:text-teal-400">Por Venir</button>
                    <button onclick="filtrarVistaCitas('historial')" id="tabHistorial" class="px-5 py-2 rounded-md text-[10px] font-black uppercase transition-all text-slate-400 hover:text-slate-600">Historial</button>
                </div>
            </div>
        </div>
        <div id="containerCitasWeb" class="space-y-6"></div>
        <div id="modalVisor" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-fade-in border border-slate-200 dark:border-slate-700">
                <div class="bg-teal-600 p-4 flex justify-between items-center">
                    <h3 class="text-white font-black uppercase italic text-sm"><i class="fas fa-file-medical mr-2"></i> Ficha de Solicitud</h3>
                    <button onclick="cerrarVisor()" class="text-white/70 hover:text-white"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div id="contenidoVisor" class="p-6 overflow-y-auto max-h-[70vh] text-left"></div>
                <div class="p-4 bg-slate-50 dark:bg-slate-900/50 border-t text-center">
                    <button onclick="cerrarVisor()" class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-6 py-2 rounded-lg font-bold text-xs uppercase hover:bg-slate-300 transition-all">Cerrar Visor</button>
                </div>
            </div>
        </div>
        <div id="toastCitas" class="fixed bottom-6 right-6 hidden z-[120]">
            <div class="bg-slate-900 text-white px-4 py-3 rounded-2xl shadow-2xl border border-white/10 max-w-sm">
                <p class="text-[10px] font-black uppercase tracking-widest text-teal-300">Sistema</p>
                <p id="toastCitasText" class="text-sm font-bold mt-1"></p>
            </div>
        </div>
    </div>

    <div id="modalPago" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md overflow-hidden text-left">
            <div class="bg-emerald-600 p-6 text-white flex justify-between items-center font-black uppercase tracking-widest italic">
                <h3>Registrar Transacci√≥n</h3>
                <button onclick="cerrarModalPago()"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-8 space-y-5 text-left">
                <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl flex justify-between items-center border border-emerald-100">
                    <span class="text-[10px] font-black uppercase text-slate-400 italic">Deuda Pendiente:</span>
                    <span id="saldoModal" class="text-xl font-black text-rose-500 font-mono italic"></span>
                </div>
                <div>
                    <div class="flex justify-between items-end mb-1 text-left">
                        <label class="label-pro font-black italic">Monto a Cobrar ($)</label>
                        <button onclick="montoTotalADeuda()" class="text-[9px] font-black text-emerald-600 underline uppercase italic">Liquidar Saldo</button>
                    </div>
                    <input type="number" id="m_monto" class="input-pro text-3xl font-black text-emerald-600 shadow-inner" placeholder="0.00">
                </div>
                <div>
                    <label class="label-pro">Forma de Pago</label>
                    <select id="m_metodo" class="input-pro font-bold" onchange="checkCanje()">
                        <option value="Efectivo">Efectivo</option><option value="Tarjeta">Tarjeta</option><option value="Yappy">Yappy / Banco</option><option value="Canje">Canje de Servicios</option>
                    </select>
                </div>
                <div id="canjeContainer" class="hidden animate-pulse"><label class="label-pro text-rose-500 italic font-black uppercase text-[9px]">Detalle del Canje</label><input type="text" id="m_detalle_canje" class="input-pro border-rose-200" placeholder="¬øQu√© se canjea?"></div>
                <div class="grid grid-cols-2 gap-2 text-left">
                    <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700"><input type="radio" name="m_motivo" value="Abono Inicial" id="motivoAbono" checked><span class="text-[9px] font-black uppercase italic">Abono Inicial</span></label>
                    <label class="flex items-center gap-2 p-3 border rounded-xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700"><input type="radio" name="m_motivo" value="Recaudo Cuota" id="motivoCuota"><span class="text-[9px] font-black uppercase italic">Recaudo</span></label>
                </div>
                <button onclick="confirmarPago()" class="w-full bg-emerald-600 text-white py-5 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-all italic text-center">CONFIRMAR E INSERTAR</button>
            </div>
        </div>
    </div>

    <div id="statementTemplate" class="hidden" style="width: 550px; padding: 40px; background: white; font-family: 'Inter', sans-serif;">
        <div style="text-align: center; border-bottom: 4px solid #0f766e; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 style="margin:0; font-size: 24px; font-weight: 900; color: #0f766e;">FIGURA ROSTRO KG</h1>
            <p style="margin:0; font-size: 10px; font-weight: 800; color: #64748b;">ESTADO DE CUENTA CL√çNICO OFICIAL</p>
        </div>
        <div style="font-size: 12px; text-align: left;">
            <p><strong>PACIENTE:</strong> <span id="s_paciente" style="text-transform: uppercase; font-weight: 800;"></span></p>
            <p><strong>FOLIO:</strong> <span id="s_folio" style="font-family: monospace;"></span></p>
            <table style="width: 100%; margin-top: 25px; border-collapse: collapse;">
                <thead style="background: #f8fafc; text-align: left; font-size: 10px;">
                    <tr><th style="padding: 10px; border: 1px solid #eee;">FECHA</th><th style="padding: 10px; border: 1px solid #eee;">MOVIMIENTO</th><th style="padding: 10px; border: 1px solid #eee; text-align: right;">VALOR</th></tr>
                </thead>
                <tbody id="s_cuerpo" style="font-size: 10px; color: #475569;"></tbody>
            </table>
            <div style="margin-top: 30px; text-align: right; font-size: 14px; font-weight: 900; border-top: 3px solid #0f766e; padding-top: 15px;">
                <p>TOTAL TRATAMIENTO: <span id="s_total" style="color: #1e293b;"></span></p>
                <p style="color: #059669;">TOTAL COBRADO: <span id="s_cobrado"></span></p>
                <p style="color: #e11d48; font-size: 20px; font-family: monospace;">SALDO PENDIENTE: <span id="s_saldo"></span></p>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBAuTfBKGuG33c9NXc1s0lkQv-7GwA47l0",
        authDomain: "figurarostro-system.firebaseapp.com",
        projectId: "figurarostro-system",
        storageBucket: "figurarostro-system.firebasestorage.app",
        messagingSenderId: "803848354693",
        appId: "1:803848354693:web:7144490abb18b0319822ec"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); 

    const colName = "pacientes_2026_oficial_v3";
    const colCitas = "reservas_entrantes";

    window.dbCache = [];
    window.currentDocId = null;
    window.historialLocal = [];
    
    let unsuscribeCitas = null; 
    window.vistaCitasActual = 'pendientes';
    window.filtroFinancieroActual = 'todos'; 

    // --- üîí SEGURIDAD (LOGIN) ---
    const loginForm = document.getElementById('loginForm');
    if(loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const btn = e.target.querySelector('button');
            const err = document.getElementById('loginError');

            btn.disabled = true; 
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> VERIFICANDO...';
            err.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                console.error("Error Auth:", error);
                err.innerText = "ACCESO DENEGADO: Credenciales incorrectas.";
                err.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-lock mr-2"></i> Iniciar Sesi√≥n';
            }
        });
    }

    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('loginOverlay');
        if (user) {
            console.log("Acceso concedido:", user.email);
            overlay.classList.add('opacity-0', 'pointer-events-none');
            initSystem(); 
        } else {
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            console.log("Esperando inicio de sesi√≥n...");
            if(unsuscribeCitas) unsuscribeCitas();
            document.getElementById('tableBody').innerHTML = '';
        }
    });

    window.logout = () => {
        if(confirm("¬øCerrar sesi√≥n de seguridad?")) signOut(auth).then(() => location.reload());
    };

    function initSystem() {
        document.querySelectorAll('.folio-display').forEach(el => el.innerText = `REQ-${Date.now().toString().slice(-6)}`);
        agregarServicio();
        setupCanvas();
        updateCitasBellUI();
        loadCitas();
        if(!document.getElementById('seccionBaseDatos').classList.contains('hidden')) {
            loadData();
        }
    }

    window.toggleDarkMode = () => document.documentElement.classList.toggle('dark');

    window.toggleView = (view) => {
        const sections = ['seccionFormulario', 'seccionBaseDatos', 'seccionCitas'];
        sections.forEach(s => document.getElementById(s).classList.add('hidden'));
        
        if (unsuscribeCitas && view !== 'appointments') { unsuscribeCitas(); unsuscribeCitas = null; }

        if(view === 'form') document.getElementById('seccionFormulario').classList.remove('hidden');
        if(view === 'list') { 
            document.getElementById('seccionBaseDatos').classList.remove('hidden'); 
            loadData(); 
            checkAlerts(); 
        }
        if(view === 'appointments') { 
            document.getElementById('seccionCitas').classList.remove('hidden'); 
            loadCitas(); 
        }
        
        document.getElementById('navForm').className = view === 'form' ? 'nav-btn-active px-4 py-2 text-[10px] font-bold transition-all' : 'px-4 py-2 text-[10px] font-bold dark:text-slate-400 transition-all';
        document.getElementById('navList').className = view === 'list' ? 'nav-btn-active px-4 py-2 text-[10px] font-bold transition-all' : 'px-4 py-2 text-[10px] font-bold dark:text-slate-400 transition-all';
        document.getElementById('navAppts').className = view === 'appointments' ? 'nav-btn-active px-4 py-2 text-[10px] font-bold transition-all' : 'px-4 py-2 text-[10px] font-bold dark:text-slate-400 transition-all';
    };

    // --- CITAS & NOTIFICACIONES ---
    const pad2 = (n) => String(n).padStart(2,'0');

    const parseHoraTo24 = (horaRaw) => {
        if(!horaRaw) return "00:00";
        const h = String(horaRaw).trim().toUpperCase();
        if (/^\d{1,2}:\d{2}$/.test(h)) { const [hh, mm] = h.split(':').map(Number); return `${pad2(hh)}:${pad2(mm)}`; }
        const m = h.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/);
        if (m) {
            let hh = parseInt(m[1], 10);
            const mm = parseInt(m[2] || "00", 10);
            const ampm = m[3];
            if (ampm === "PM" && hh < 12) hh += 12;
            if (ampm === "AM" && hh === 12) hh = 0;
            return `${pad2(hh)}:${pad2(mm)}`;
        }
        return "00:00";
    };

    const citaDateTime = (fechaYYYYMMDD, horaRaw) => {
        try {
            const [y,m,d] = (fechaYYYYMMDD || "1970-01-01").split('-').map(Number);
            const hhmm = parseHoraTo24(horaRaw);
            const [hh, mm] = hhmm.split(':').map(Number);
            return new Date(y, (m||1)-1, d||1, hh||0, mm||0, 0, 0);
        } catch(e) { return new Date(1970,0,1); }
    };

    const minutesDiff = (a, b) => Math.round((a - b) / 60000);

    window.filtrarVistaCitas = (vista) => {
        window.vistaCitasActual = vista;
        const btnP = document.getElementById('tabPendientes');
        const btnH = document.getElementById('tabHistorial');
        if(vista === 'pendientes') {
            btnP.className = "px-5 py-2 rounded-md text-[10px] font-black uppercase transition-all bg-white dark:bg-slate-700 shadow-sm text-teal-700 dark:text-teal-400";
            btnH.className = "px-5 py-2 rounded-md text-[10px] font-black uppercase transition-all text-slate-400 hover:text-slate-600";
        } else {
            btnP.className = "px-5 py-2 rounded-md text-[10px] font-black uppercase transition-all text-slate-400 hover:text-slate-600";
            btnH.className = "px-5 py-2 rounded-md text-[10px] font-black uppercase transition-all bg-white dark:bg-slate-700 shadow-sm text-purple-700 dark:text-purple-400";
        }
        loadCitas();
    };

    window.citasFirstSnapshotDone = false;
    const LS_FEED = "kg_citas_feed_items_v1";
    const LS_UNSEEN = "kg_citas_unseen_v1";
    const LS_BASELINE = "kg_citas_baseline_reg_v1";

    window.citasFeedItems = JSON.parse(localStorage.getItem(LS_FEED) || "[]");
    window.citasUnseen = parseInt(localStorage.getItem(LS_UNSEEN) || "0", 10);
    window.citasBaselineReg = localStorage.getItem(LS_BASELINE) || null; 

    const saveCitasFeed = () => {
        localStorage.setItem(LS_FEED, JSON.stringify(window.citasFeedItems.slice(0, 50)));
        localStorage.setItem(LS_UNSEEN, String(window.citasUnseen));
        localStorage.setItem(LS_BASELINE, window.citasBaselineReg || "");
    };

    const updateCitasBellUI = () => {
        const badge = document.getElementById('citasNewCount');
        const icon  = document.getElementById('citasBellIcon');
        badge.innerText = window.citasUnseen;
        badge.classList.toggle('hidden', window.citasUnseen <= 0);
        if (window.citasUnseen > 0) icon.classList.add('animate-pulse');
        else icon.classList.remove('animate-pulse');
    };

    const renderCitasFeed = () => {
        const list = document.getElementById('citasFeedList');
        if (!list) return;
        if (!window.citasFeedItems.length) {
            list.innerHTML = `<div class="p-6 text-center opacity-60"><i class="far fa-bell text-3xl text-slate-300"></i><p class="mt-2 text-xs font-bold text-slate-400 uppercase">Sin notificaciones nuevas</p></div>`;
            return;
        }
        list.innerHTML = window.citasFeedItems.map(item => `
            <div class="p-3 rounded-xl border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30">
                <p class="text-[9px] font-black uppercase tracking-widest text-teal-600">Nueva reserva</p>
                <p class="text-sm font-black text-slate-800 dark:text-white mt-0.5">${item.nombre || 'Paciente'}</p>
                <p class="text-[10px] font-bold text-slate-500 mt-1">
                    <i class="far fa-calendar mr-1 text-slate-400"></i>${item.fecha || '--'}
                    <span class="mx-2 opacity-40">‚Ä¢</span>
                    <i class="far fa-clock mr-1 text-slate-400"></i>${item.hora || '--'}
                </p>
                <p class="text-[10px] font-bold text-slate-500 mt-1 line-clamp-2">${item.servicio || ''}</p>
            </div>`).join('');
    };

    const toastCitas = (msg) => {
        const box = document.getElementById('toastCitas');
        const txt = document.getElementById('toastCitasText');
        txt.innerText = msg;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 2500);
    };

    const beepCitas = () => {
        try {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioCtx();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.05;
            o.connect(g); g.connect(ctx.destination);
            o.start(); setTimeout(() => { o.stop(); ctx.close(); }, 140);
        } catch(e) {}
    };

    window.toggleCitasFeed = () => {
        const panel = document.getElementById('citasFeed');
        panel.classList.toggle('hidden');
        renderCitasFeed();
        if (!panel.classList.contains('hidden')) { window.citasUnseen = 0; saveCitasFeed(); updateCitasBellUI(); }
    };

    window.clearCitasFeed = () => {
        window.citasFeedItems = []; window.citasUnseen = 0;
        saveCitasFeed(); updateCitasBellUI(); renderCitasFeed();
        toastCitas("Notificaciones limpiadas.");
    };

    window.refreshCitas = () => { loadCitas(true); toastCitas("Agenda actualizada."); };

    // =========================
    // ‚úÖ LOAD CITAS (RESTORED)
    // =========================
    window.loadCitas = (isManualRefresh = false) => {
        const container = document.getElementById('containerCitasWeb');
        container.innerHTML = '<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-teal-500 text-3xl"></i><p class="mt-2 text-xs font-bold text-slate-400 uppercase">Organizando Agenda...</p></div>';

        const q = query(collection(db, colCitas), orderBy("fecha_cita", "asc"));
        if (unsuscribeCitas) unsuscribeCitas();

        window.citasFirstSnapshotDone = false;

        unsuscribeCitas = onSnapshot(q, (snapshot) => {
            const now = new Date();

            // Baseline
            if (!window.citasBaselineReg) {
                let maxISO = null;
                snapshot.forEach(ds => {
                    const d = ds.data();
                    const fr = d.fecha_registro?.seconds ? new Date(d.fecha_registro.seconds * 1000) : null;
                    if (fr) {
                        const iso = fr.toISOString();
                        if (!maxISO || iso > maxISO) maxISO = iso;
                    }
                });
                window.citasBaselineReg = maxISO || now.toISOString();
                saveCitasFeed();
            }

            handleNewIncomingCitas(snapshot);

            container.innerHTML = '';
            let pendientesActivas = []; let pendientesVencidas = []; let historial = [];

            snapshot.forEach((docSnap) => {
                const c = { id: docSnap.id, ...docSnap.data() };
                const est = c.estado || "Pendiente";
                const dt = citaDateTime(c.fecha_cita, c.hora_cita);
                const minutesSinceStart = minutesDiff(now, dt);
                const autoArchivada = (est === 'Pendiente' && minutesSinceStart >= 180);

                if (autoArchivada) {
                    c._autoArchived = true; c._estadoVisual = "Archivada"; historial.push(c); return;
                }

                if (est === 'Pendiente') {
                    const todayStr = new Date().toLocaleDateString('en-CA');
                    if (c.fecha_cita < todayStr) pendientesVencidas.push(c);
                    else pendientesActivas.push(c);
                } else {
                    historial.push(c);
                }
            });

            // Proxima Real
            const allPendientesVigentes = [...pendientesActivas, ...pendientesVencidas];
            let proximaId = null;
            const eligibles = allPendientesVigentes
                .map(c => ({ c, dt: citaDateTime(c.fecha_cita, c.hora_cita) }))
                .filter(x => x.dt.getTime() >= (now.getTime() - 60 * 60000))
                .sort((a,b) => a.dt - b.dt);

            if (eligibles.length) proximaId = eligibles[0].c.id;
            else {
                const future = allPendientesVigentes
                    .map(c => ({ c, dt: citaDateTime(c.fecha_cita, c.hora_cita) }))
                    .filter(x => x.dt.getTime() >= now.getTime())
                    .sort((a,b) => a.dt - b.dt);
                if (future.length) proximaId = future[0].c.id;
            }

            pendientesActivas.sort((a,b) => citaDateTime(a.fecha_cita, a.hora_cita) - citaDateTime(b.fecha_cita, b.hora_cita));
            pendientesVencidas.sort((a,b) => citaDateTime(a.fecha_cita, a.hora_cita) - citaDateTime(b.fecha_cita, b.hora_cita));
            historial.sort((a,b) => citaDateTime(b.fecha_cita, b.hora_cita) - citaDateTime(a.fecha_cita, a.hora_cita));

            if (window.vistaCitasActual === 'pendientes') {
                if (pendientesActivas.length === 0 && pendientesVencidas.length === 0) {
                    container.innerHTML = `<div class="p-10 border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-2xl text-center opacity-60"><i class="far fa-calendar-check text-4xl text-slate-300 mb-2"></i><p class="text-slate-400 font-bold uppercase text-xs">Agenda al d√≠a. No hay pendientes.</p></div>`;
                    return;
                }
                if (pendientesActivas.length > 0) {
                    container.innerHTML += `<div class="text-xs font-black text-teal-600 uppercase tracking-widest mb-3 border-b pb-1">üìÖ Pr√≥ximas Citas (Prioridad)</div>`;
                    container.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8">` + pendientesActivas.map(c => renderCard(c, false, c.id === proximaId)).join('') + `</div>`;
                }
                if (pendientesVencidas.length > 0) {
                    container.innerHTML += `<div class="text-xs font-black text-rose-400 uppercase tracking-widest mb-3 border-b border-rose-100 pb-1 mt-6">‚ö†Ô∏è Citas Vencidas / Por Recuperar</div>`;
                    container.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 opacity-90">` + pendientesVencidas.map(c => renderCard(c, true, c.id === proximaId)).join('') + `</div>`;
                }
            } else {
                if (historial.length === 0) {
                    container.innerHTML = `<div class="p-10 text-center opacity-50"><p class="text-slate-400 font-bold uppercase text-xs">Historial Vac√≠o</p></div>`;
                } else {
                    container.innerHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">` + historial.map(c => renderCard(c, false, false)).join('') + `</div>`;
                }
            }
        });
    };

    const handleNewIncomingCitas = (snapshot) => {
        if (!window.citasFirstSnapshotDone) { window.citasFirstSnapshotDone = true; updateCitasBellUI(); return; }
        const seccionCitasVisible = !document.getElementById('seccionCitas').classList.contains('hidden');
        if (!seccionCitasVisible) return;

        const changes = snapshot.docChanges();
        const nuevos = changes.filter(ch => ch.type === 'added').map(ch => ({ id: ch.doc.id, ...ch.doc.data() }));
        if (!nuevos.length) return;

        const baselineISO = window.citasBaselineReg || new Date().toISOString();
        const nuevosReales = nuevos.filter(n => {
            const est = (n.estado || 'Pendiente');
            if (est !== 'Pendiente') return false;
            const fr = n.fecha_registro?.seconds ? new Date(n.fecha_registro.seconds * 1000).toISOString() : null;
            if (!fr) return false;
            return fr > baselineISO;
        });

        if (!nuevosReales.length) return;

        let maxISO = baselineISO;
        nuevosReales.forEach(n => {
            const frISO = new Date(n.fecha_registro.seconds * 1000).toISOString();
            if (frISO > maxISO) maxISO = frISO;
        });
        window.citasBaselineReg = maxISO;

        nuevosReales.forEach(n => {
            const item = { nombre: n.nombre || "Paciente", fecha: n.fecha_cita || "", hora: tConvert(n.hora_cita), servicio: n.servicio || "", ts: Date.now() };
            window.citasFeedItems.unshift(item);
        });

        window.citasUnseen += nuevosReales.length;
        saveCitasFeed(); updateCitasBellUI();
        const n0 = nuevosReales[0];
        toastCitas(`Nueva reserva: ${n0.nombre || 'Paciente'} ‚Ä¢ ${n0.fecha_cita || ''} ‚Ä¢ ${tConvert(n0.hora_cita)}`);
        beepCitas();
    };

    const renderCard = (c, esVencida, esProxima) => {
        const dt = citaDateTime(c.fecha_cita, c.hora_cita);
        const now = new Date();
        const minsTo = minutesDiff(dt, now); const minsSince = minutesDiff(now, dt);
        const inLessThan2h = (minsTo >= 0 && minsTo <= 120);
        const [y, m, d] = (c.fecha_cita || "1970-01-01").split('-');
        const fObj = new Date(parseInt(y,10), parseInt(m,10) - 1, parseInt(d,10));
        const diaTxt = fObj.toLocaleString('es-ES', { weekday: 'short' }).replace('.', '').toUpperCase();
        const mesTxt = fObj.toLocaleString('es-ES', { month: 'short' }).replace('.', '').toUpperCase();

        let colorBorde = esVencida ? "border-rose-400" : "border-teal-500";
        let bgFecha = esVencida ? "bg-rose-50 text-rose-700" : "bg-teal-50 text-teal-800";
        const estadoReal = c._autoArchived ? "Archivada" : (c.estado || "Pendiente");

        if (estadoReal === 'Asisti√≥') { colorBorde = "border-emerald-500 opacity-70 grayscale"; bgFecha = "bg-emerald-100 text-emerald-800"; }
        if (estadoReal === 'Falt√≥')   { colorBorde = "border-slate-400 opacity-60 grayscale"; bgFecha = "bg-slate-200 text-slate-700"; }
        if (estadoReal === 'Archivada') { colorBorde = "border-slate-300 opacity-70"; bgFecha = "bg-slate-100 text-slate-700"; }

        let acciones = '';
        if (window.vistaCitasActual === 'pendientes') {
            acciones = `
                <div class="flex flex-col h-full border-l border-slate-100 dark:border-slate-700">
                    <button onclick='verDetalles(${JSON.stringify(c).replace(/'/g, "&#39;")})' class="flex-1 px-3 bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-all text-xs" title="Ver Ficha Completa"><i class="fas fa-eye"></i></button>
                    <button onclick="cambiarEstadoCita('${c.id}', 'Asisti√≥')" class="flex-1 px-3 bg-emerald-50 text-emerald-500 hover:bg-emerald-500 hover:text-white transition-all text-xs" title="Asisti√≥"><i class="fas fa-check"></i></button>
                    <button onclick="cambiarEstadoCita('${c.id}', 'Falt√≥')" class="flex-1 px-3 bg-rose-50 text-rose-400 hover:bg-rose-500 hover:text-white transition-all text-xs" title="No Vino"><i class="fas fa-times"></i></button>
                </div>
            `;
        } else {
            acciones = `
                <div class="flex flex-col h-full border-l border-slate-100 dark:border-slate-700">
                     <button onclick='verDetalles(${JSON.stringify(c).replace(/'/g, "&#39;")})' class="h-1/2 px-3 bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-all text-xs" title="Ver Ficha"><i class="fas fa-eye"></i></button>
                     <button onclick="eliminarCitaDefinitiva('${c.id}')" class="h-1/2 px-3 bg-slate-100 text-slate-400 hover:bg-rose-500 hover:text-white transition-all text-xs" title="Eliminar"><i class="fas fa-trash"></i></button>
                </div>
            `;
        }

        const horaBonita = tConvert(c.hora_cita);
        const badgeProxima = esProxima ? `<span class="bg-amber-100 text-amber-800 border border-amber-200 text-[9px] font-black px-2 py-1 rounded-lg uppercase animate-pulse"><i class="fas fa-bolt mr-1"></i> PR√ìXIMA</span>` : '';
        const badge2h = (inLessThan2h && (estadoReal === 'Pendiente')) ? `<span class="bg-rose-100 text-rose-700 border border-rose-200 text-[9px] font-black px-2 py-1 rounded-lg uppercase animate-pulse"><i class="far fa-clock mr-1"></i> EN &lt; 2H</span>` : '';
        const badgeEstado = (estadoReal && estadoReal !== 'Pendiente') ? `<span class="bg-slate-100 text-slate-500 text-[8px] font-black px-1.5 rounded uppercase">${estadoReal}</span>` : '';
        const badgeVencida = esVencida ? `<span class="bg-rose-100 text-rose-600 text-[8px] font-black px-1.5 rounded uppercase">Vencida</span>` : '';
        const timePill = `<span class="shrink-0 bg-teal-50 text-teal-800 border border-teal-200 text-[12px] font-black px-3 py-1.5 rounded-full shadow-sm uppercase"><i class="far fa-clock mr-1 text-teal-500"></i>${horaBonita}</span>`;

        return `
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border-l-4 ${colorBorde} flex overflow-hidden h-32 relative border-y border-r border-slate-100 dark:border-slate-700">
                <div class="${bgFecha} w-20 flex flex-col items-center justify-center shrink-0 border-r border-slate-100 dark:border-slate-700 p-1 leading-none">
                    <span class="text-[10px] font-black uppercase tracking-wider opacity-80">${diaTxt}</span>
                    <span class="text-3xl font-black my-1">${parseInt(d,10)}</span>
                    <span class="text-[10px] font-black uppercase tracking-wider opacity-80">${mesTxt}</span>
                </div>
                
                <div class="p-3 flex-1 min-w-0 flex flex-col justify-center text-left">
                    <div class="flex items-start justify-between gap-2 mb-1">
                        <div class="min-w-0">
                            <div class="flex flex-wrap items-center gap-2">
                                <h3 class="font-black text-sm text-slate-800 dark:text-white truncate uppercase">${c.nombre}</h3>
                                ${badgeProxima}
                                ${badge2h}
                                ${badgeVencida}
                                ${badgeEstado}
                            </div>
                        </div>
                        ${timePill}
                    </div>

                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 truncate"><i class="fas fa-briefcase mr-1 text-slate-300"></i> ${c.ocupacion || 'Sin ocupaci√≥n'}</p>
                    <p class="text-[10px] font-black text-teal-600 dark:text-teal-400 uppercase mb-1 line-clamp-2">${c.servicio || ''}</p>
                    
                    <div class="flex items-center gap-2 mt-1">
                        <a href="https://wa.me/507${c.whatsapp}" target="_blank" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded shadow-sm font-bold text-[10px] flex items-center gap-1 transition-all no-print">
                            <i class="fab fa-whatsapp"></i> ${c.whatsapp}
                        </a>
                        <span class="text-[9px] text-slate-400 truncate"><i class="fas fa-map-marker-alt text-slate-300 ml-1"></i> ${c.zona || ''}</span>
                    </div>
                </div>

                ${acciones}
            </div>
        `;
    };

    window.verDetalles = (c) => {
        const modal = document.getElementById('modalVisor');
        const contenido = document.getElementById('contenidoVisor');
        const antecedentes = c.antecedentes ? c.antecedentes.join(", ") : "Ninguno";
        
        contenido.innerHTML = `
            <div class="space-y-4 text-xs text-slate-600 dark:text-slate-300">
                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                    <p><strong>FECHA REGISTRO:</strong> ${c.fecha_registro ? new Date(c.fecha_registro.seconds * 1000).toLocaleString() : 'N/A'}</p>
                    <p class="mt-1"><strong>INTENCI√ìN:</strong> <span class="text-teal-600 font-black uppercase">${c.intencion || '-'}</span></p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="label-pro mb-1">Nombre</p>
                        <p class="font-bold text-slate-800 dark:text-white uppercase">${c.nombre || '-'}</p>
                    </div>
                    <div>
                        <p class="label-pro mb-1">Edad</p>
                        <p class="font-bold">${c.edad || '-'} A√±os</p>
                    </div>
                    <div>
                        <p class="label-pro mb-1">Ocupaci√≥n</p>
                        <p class="font-bold uppercase">${c.ocupacion || '-'}</p>
                    </div>
                    <div>
                        <p class="label-pro mb-1">Provincia</p>
                        <p class="font-bold uppercase">${c.provincia || '-'}</p>
                    </div>
                </div>
                
                <div class="border-t border-slate-100 dark:border-slate-700 pt-3">
                    <p class="label-pro mb-1 text-purple-600">Motivaci√≥n (¬øQu√© le inspira?)</p>
                    <p class="italic">"${c.motivacion || '-'}"</p>
                </div>

                <div>
                    <p class="label-pro mb-1 text-rose-500">Antecedentes M√©dicos</p>
                    <p class="font-bold uppercase text-rose-600">${antecedentes}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <div class="bg-teal-50 p-2 rounded border border-teal-100">
                        <p class="text-[9px] font-black text-teal-700 uppercase">Servicio</p>
                        <p class="font-bold text-teal-800 text-[10px]">${c.servicio || '-'}</p>
                    </div>
                    <div class="bg-blue-50 p-2 rounded border border-blue-100">
                        <p class="text-[9px] font-black text-blue-700 uppercase">M√©todo Pago</p>
                        <p class="font-bold text-blue-800 text-[10px]">${c.metodo_pago || '-'}</p>
                    </div>
                </div>
            </div>
        `;
        modal.classList.remove('hidden');
    };

    window.cerrarVisor = () => document.getElementById('modalVisor').classList.add('hidden');
    
    window.tConvert = (time) => {
        if(!time) return '--:--';
        time = time.toString().trim();
        if (/(AM|PM)$/i.test(time)) return time.toUpperCase().replace(/\s+/g,' ');
        let m = time.match(/^([01]?\d|2[0-3]):([0-5]\d)$/);
        if (!m) return time;
        let hh = parseInt(m[1],10), mm = m[2];
        const ampm = hh < 12 ? 'AM' : 'PM';
        hh = hh % 12; if (hh === 0) hh = 12;
        return `${pad2(hh)}:${mm} ${ampm}`;
    }

    window.cambiarEstadoCita = async (id, nuevoEstado) => {
        if(confirm(`¬øMarcar como "${nuevoEstado}"?`)) {
            try { await updateDoc(doc(db, colCitas, id), { estado: nuevoEstado }); } 
            catch (e) { alert("Error: " + e.message); }
        }
    };

    window.eliminarCitaDefinitiva = async (id) => {
        if(confirm("¬øBorrar permanentemente?")) {
            try { await deleteDoc(doc(db, colCitas, id)); } 
            catch (e) { alert("Error: " + e.message); }
        }
    };

    window.filtrarFinanzas = (tipo) => {
        window.filtroFinancieroActual = tipo;
        
        const inactivo = "px-5 py-2 text-[10px] font-black uppercase rounded-lg bg-white dark:bg-slate-700 text-slate-500 hover:bg-slate-50 border border-slate-200 dark:border-slate-600 transition-all";
        const activoBase = "px-5 py-2 text-[10px] font-black uppercase rounded-lg text-white shadow-md transition-all border-transparent";
        
        document.getElementById('tabTodos').className = inactivo;
        document.getElementById('tabDeuda').className = inactivo;
        document.getElementById('tabAldia').className = inactivo;

        if(tipo === 'todos') document.getElementById('tabTodos').className = activoBase + " bg-slate-800";
        if(tipo === 'deuda') document.getElementById('tabDeuda').className = activoBase + " bg-rose-500";
        if(tipo === 'aldia') document.getElementById('tabAldia').className = activoBase + " bg-emerald-500";

        renderTabla(); 
    };

    window.renderTabla = () => {
        const tb = document.getElementById('tableBody');
        tb.innerHTML = '';
        const filtro = window.filtroFinancieroActual;

        const datosFiltrados = window.dbCache.filter(d => {
            let pendienteRaw = d.finanzas.pendiente || "0";
            if(typeof pendienteRaw === 'string') pendienteRaw = pendienteRaw.replace('$','').replace('S. Favor: ','');
            const pendienteVal = parseFloat(pendienteRaw);

            if (filtro === 'deuda') return pendienteVal > 0.50; 
            if (filtro === 'aldia') return pendienteVal <= 0.50;
            return true; 
        });

        if(datosFiltrados.length === 0) {
            tb.innerHTML = '<tr><td colspan="7" class="p-10 text-center opacity-50 font-bold italic text-slate-400">NO HAY REGISTROS EN ESTA VISTA</td></tr>';
            return;
        }

        datosFiltrados.forEach(d => {
            let pendienteRaw = d.finanzas.pendiente || "0";
            let esDeuda = false;
            if(typeof pendienteRaw === 'string') {
                 const val = parseFloat(pendienteRaw.replace('$','').replace('S. Favor: ',''));
                 esDeuda = val > 0.50;
            }

            const bgRow = esDeuda ? "bg-rose-50/60 dark:bg-rose-900/20" : "";
            const txtPendiente = esDeuda ? "text-rose-600 dark:text-rose-400" : "text-emerald-400 opacity-60";
            const badgeDeuda = esDeuda ? '<span class="ml-2 bg-rose-500 text-white text-[7px] px-1.5 py-0.5 rounded tracking-wider">PENDIENTE</span>' : '';

            tb.innerHTML += `
            <tr class="border-b ${bgRow} hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-left group">
                <td class="p-4 font-mono font-bold text-slate-400 text-[10px]">${d.folio}</td>
                <td class="font-black uppercase text-slate-700 dark:text-white text-xs">
                    ${d.paciente.nombre}
                    ${badgeDeuda}
                </td>
                <td class="text-slate-400 italic text-[10px]">${d.paciente.ocupacion || '-'}</td>
                <td class="text-right font-black dark:text-slate-300 text-xs">${d.finanzas.total}</td>
                <td class="text-right text-emerald-600 font-bold text-xs opacity-80">$${parseFloat(d.finanzas.abono || 0).toFixed(2)}</td>
                <td class="text-right ${txtPendiente} font-black tracking-tighter text-sm">${d.finanzas.pendiente}</td>
                <td class="p-4 flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editarFicha('${d.id}')" class="p-2 bg-slate-800 text-white rounded shadow hover:scale-110 transition-all" title="Editar / Cobrar"><i class="fas fa-edit text-xs"></i></button>
                    <button onclick="descargarEstadoCuenta('${d.id}')" class="p-2 bg-white border border-slate-200 text-slate-600 rounded shadow hover:scale-110 transition-all" title="Estado de Cuenta"><i class="fas fa-file-invoice-dollar text-xs"></i></button>
                </td>
            </tr>`;
        });
    };

    window.loadData = async () => {
        const tb = document.getElementById('tableBody'); 
        tb.innerHTML = '<tr><td colspan="7" class="p-10 text-center font-bold text-slate-400 animate-pulse text-xs tracking-widest">CARGANDO BASE DE DATOS...</td></tr>';
        
        try {
            const q = query(collection(db, colName), orderBy("fecha", "desc"));
            const s = await getDocs(q);
            window.dbCache = []; 
            s.forEach(snap => { 
                window.dbCache.push({ id: snap.id, ...snap.data() }); 
            });
            renderTabla(); 
            checkAlerts(); 
        } catch(e) { 
            console.error(e); 
            tb.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-rose-500 font-bold">Error: ${e.message}</td></tr>`;
        }
    };

    window.limpiarFormulario = () => { if(confirm("¬øNueva ficha?")) location.reload(); }

    window.calcularEdad = () => {
        const d = document.getElementById('dia_nac').value, m = document.getElementById('mes_nac').value, a = document.getElementById('anio_nac').value;
        if(d && m && a) {
            const birth = new Date(a, m - 1, d), today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--;
            document.getElementById('edad').value = `${age} a√±os`;
        }
    };

    window.setDescuento = (val) => { document.getElementById('descuento_pct').value = val; calcularTotal(); }
    window.setBono = (val) => { document.getElementById('bono_manual').value = val; calcularTotal(); }
    
    window.aplicarPctAbono = (pct) => {
        const total = parseFloat(document.getElementById('lblTotal').innerText.replace('$','')) || 0;
        document.getElementById('m_monto').value = (total * (pct / 100)).toFixed(2);
        abrirModalPago();
    };

    window.toggleCuotas = () => {
        const usa = document.getElementById('usa_cuotas').checked;
        document.getElementById('cuotasContainer').classList.toggle('hidden', !usa);
        if(usa && !window.currentDocId) generarCamposFechas();
        calcularTotal();
    };

    window.generarCamposFechas = () => {
        const n = parseInt(document.getElementById('num_cuotas').value);
        const container = document.getElementById('camposFechas'); container.innerHTML = '';
        for(let i=1; i<=n; i++) container.innerHTML += `<div class="text-left"><label class="label-pro italic uppercase text-[9px]">Pago Cuota ${i}</label><input type="date" class="input-pro f-cuota shadow-inner" onchange="calcularTotal()"></div>`;
    };

    window.agregarServicio = (t='Plasma Fibroblast', z='', p='') => {
        const id = Date.now() + Math.random();
        const html = `<div class="service-row" id="row-${id}">
            <select class="input-pro s-type font-black text-[11px] h-12 uppercase"><option value="Plasma Fibroblast" ${t==='Plasma Fibroblast'?'selected':''}>Plasma Fibroblast</option><option value="Hidroplasia" ${t==='Hidroplasia'?'selected':''}>Hidroplasia</option><option value="Dermapen" ${t==='Dermapen'?'selected':''}>Dermapen</option><option value="Otro" ${t==='Otro'?'selected':''}>Otro...</option></select>
            <input type="text" class="input-pro s-zone text-[11px] h-12 uppercase" placeholder="ZONA" value="${z}">
            <input type="number" class="input-pro text-right font-black s-price text-[11px] h-12" placeholder="0" value="${p}" oninput="calcularTotal()">
            <button type="button" onclick="document.getElementById('row-${id}').remove(); calcularTotal();" class="text-rose-500 hover:scale-110 transition-all"><i class="fas fa-trash"></i></button>
        </div>`;
        document.getElementById('listaServicios').insertAdjacentHTML('beforeend', html);
    };

    window.calcularTotal = () => {
    let sub = 0; 
    document.querySelectorAll('.s-price').forEach(i => sub += parseFloat(i.value) || 0);
    
    const pct = parseFloat(document.getElementById('descuento_pct').value) || 0;
    const bono = parseFloat(document.getElementById('bono_manual').value) || 0;
    const totalFinal = Math.max(0, sub - (sub * (pct / 100)) - bono);
    
    // Suma de todo el historial sin errores
    const cobradoTotal = window.historialLocal.reduce((acc, curr) => acc + (parseFloat(curr.monto) || 0), 0);
    const saldo = totalFinal - cobradoTotal;

    document.getElementById('sub_txt').innerText = `$${sub.toFixed(2)}`;
    document.getElementById('desc_txt').innerText = `-$${(sub * (pct / 100)).toFixed(2)}`;
    document.getElementById('bono_txt').innerText = `-$${bono.toFixed(2)}`;
    document.getElementById('lblTotal').innerText = `$${totalFinal.toFixed(2)}`;
    
    const lblP = document.getElementById('lblPendiente');
    if (saldo <= 0.05) {
        lblP.innerText = "$0.00";
        lblP.className = "text-3xl font-black text-emerald-500 font-mono italic";
    } else {
        lblP.innerText = `$${saldo.toFixed(2)}`;
        lblP.className = "text-3xl font-black text-rose-500 font-mono italic";
    }

    document.getElementById('abono_anterior').value = cobradoTotal.toFixed(2);
    
    if(document.getElementById('usa_cuotas').checked && !window.currentDocId) {
        const n = parseInt(document.getElementById('num_cuotas').value);
        document.getElementById('desgloseCuotas').innerText = `${n} CUOTAS DE $${(saldo / n).toFixed(2)}`;
    }
};

    window.abrirModalPago = () => {
        const saldoStr = document.getElementById('lblPendiente').innerText.replace('$','').replace('S. Favor: ','');
        document.getElementById('saldoModal').innerText = `$${parseFloat(saldoStr).toFixed(2)}`;
        document.getElementById('modalPago').classList.remove('hidden');
    };

    window.cerrarModalPago = () => document.getElementById('modalPago').classList.add('hidden');
    window.montoTotalADeuda = () => {
        const saldo = parseFloat(document.getElementById('lblPendiente').innerText.replace('$','').replace('S. Favor: ',''));
        document.getElementById('m_monto').value = Math.max(0, saldo).toFixed(2);
    };

    window.checkCanje = () => document.getElementById('canjeContainer').classList.toggle('hidden', document.getElementById('m_metodo').value !== 'Canje');

    window.confirmarPago = () => {
        const monto = parseFloat(document.getElementById('m_monto').value);
        if(!monto || monto <= 0) return alert("Ingrese un monto v√°lido.");
        
        const motivo = document.querySelector('input[name="m_motivo"]:checked').value;
        const nRec = window.historialLocal.filter(h => h.motivo.includes('Recaudo')).length + 1;
        const pago = { fecha: new Date().toLocaleDateString('es-PA'), monto, metodo: document.getElementById('m_metodo').value, motivo: (motivo === 'Recaudo Cuota' ? `Recaudo ${nRec}` : motivo), detalle: document.getElementById('m_detalle_canje').value };
        window.historialLocal.push(pago);
        actualizarHistorialUI(); calcularTotal(); cerrarModalPago();
    };

    window.actualizarHistorialUI = () => {
        const container = document.getElementById('listaHistorial'); container.innerHTML = '';
        window.historialLocal.forEach((p, idx) => {
            container.innerHTML += `<div class="p-2 border-b bg-white dark:bg-slate-700 rounded flex justify-between items-center group transition-all">
                <span class="text-left">${p.fecha} - <b>${p.metodo}</b> (${p.motivo}) ${p.detalle || ''}</span>
                <div class="flex items-center gap-4"><span class="text-emerald-600 font-bold">$${p.monto.toFixed(2)}</span><button onclick="borrarPago(${idx})" class="text-rose-400 no-print opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button></div>
            </div>`;
        });
    };

    window.borrarPago = (idx) => { if(confirm("¬øEliminar pago?")) { window.historialLocal.splice(idx,1); actualizarHistorialUI(); calcularTotal(); } };

    window.filtrarTabla = () => {
        const val = document.getElementById('buscador').value.toUpperCase();
        const rows = document.getElementById('tableBody').getElementsByTagName('tr');
        for(let r of rows) r.style.display = r.innerText.toUpperCase().includes(val) ? '' : 'none';
    };

    window.editarFicha = (id) => {
    const r = window.dbCache.find(x => x.id === id); 
    window.currentDocId = id;
    
    // 1. Mostrar banner de edici√≥n y cargar Folio
    document.getElementById('editModeBanner').classList.remove('hidden');
    document.querySelectorAll('.folio-display').forEach(e => e.innerText = r.folio);
    
    // 2. Cargar Datos Personales
    document.getElementById('nombre').value = r.paciente.nombre;
    document.getElementById('telefono').value = r.paciente.celular;
    document.getElementById('cedula').value = r.paciente.cedula || '';
    document.getElementById('email_paciente').value = r.paciente.email || '';
    document.getElementById('ocupacion').value = r.paciente.ocupacion || '';
    document.getElementById('direccion').value = r.paciente.direccion || '';
    document.getElementById('fecha_inicio_real').value = r.fecha_inicio || '';
    document.getElementById('observaciones').value = r.observaciones || '';

    // 3. REPARACI√ìN: Cargar Descuento y Bono ANTES de calcular
    document.getElementById('descuento_pct').value = r.finanzas.descuento_pct || 0;
    document.getElementById('bono_manual').value = r.finanzas.bono || 0;
    
    // 4. Limpiar y cargar los servicios contratados
    document.getElementById('listaServicios').innerHTML = '';
    if(r.servicios) r.servicios.forEach(s => agregarServicio(s.tipo, s.zona, s.precio));

    // 5. REPARACI√ìN: Cargar el historial de pagos completo para que el saldo sea exacto
    window.historialLocal = r.historial || [];
    actualizarHistorialUI();

    // 6. REPARACI√ìN CLAVE: Forzamos el rec√°lculo inmediato. 
    // Esto hace que el Saldo y el Total aparezcan id√©nticos a como los dejaste antes.
    setTimeout(() => {
        calcularTotal();
    }, 150);

    // L√≥gica para el plan de cuotas pactado
    const checkC = document.getElementById('usa_cuotas');
    checkC.checked = r.finanzas.usa_cuotas || false;
    if(checkC.checked) {
        checkC.disabled = true;
        document.getElementById('planEditableUI').classList.add('hidden');
        document.getElementById('planPactadoDisplay').classList.remove('hidden');
        document.getElementById('txtPlanPactado').innerText = `${r.finanzas.num_cuotas} CUOTAS QUINCENALES (PACTO ORIGINAL)`;
        document.getElementById('cuotasContainer').classList.remove('hidden');
    } else {
        checkC.disabled = false;
        document.getElementById('planEditableUI').classList.remove('hidden');
        document.getElementById('planPactadoDisplay').classList.add('hidden');
    }

    // Cambiar vista y subir el scroll
    toggleView('form'); 
    window.scrollTo({top: 0, behavior: 'smooth'});
};
        }

        document.getElementById('observaciones').value = r.observaciones || '';
        window.historialLocal = r.historial || [];
        actualizarHistorialUI();
        document.getElementById('listaServicios').innerHTML = '';
        if(r.servicios) r.servicios.forEach(s => agregarServicio(s.tipo, s.zona, s.precio));
        
        setTimeout(() => {
            const inputs = document.querySelectorAll('.f-cuota');
            if(r.finanzas.fechas_cuotas) r.finanzas.fechas_cuotas.forEach((f, i) => { if(inputs[i]) { inputs[i].value = f; inputs[i].disabled = true; } });
        }, 200);

        toggleView('form'); window.scrollTo({top: 0, behavior: 'smooth'}); calcularTotal();
    };

    window.descargarEstadoCuenta = (id) => {
        const d = window.dbCache.find(x => x.id === id);
        document.getElementById('s_paciente').innerText = d.paciente.nombre;
        document.getElementById('s_folio').innerText = d.folio;
        document.getElementById('s_total').innerText = d.finanzas.total;
        document.getElementById('s_cobrado').innerText = `$${parseFloat(d.finanzas.abono).toFixed(2)}`;
        document.getElementById('s_saldo').innerText = d.finanzas.pendiente;
        const tb = document.getElementById('s_cuerpo'); tb.innerHTML = '';
        d.historial.forEach(p => { tb.innerHTML += `<tr><td style="padding:10px; border-bottom:1px solid #eee;">${p.fecha}</td><td style="padding:10px; border-bottom:1px solid #eee;">${p.metodo} (${p.motivo})</td><td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">$${parseFloat(p.monto).toFixed(2)}</td></tr>`; });
        const el = document.getElementById('statementTemplate'); el.classList.remove('hidden');
        html2pdf().from(el).set({ margin: 10, filename: `EstadoCuenta_${d.paciente.nombre}.pdf` }).save().then(()=>el.classList.add('hidden'));
    };

    window.checkAlerts = () => {
        const list = document.getElementById('alertList'); list.innerHTML = ''; let count = 0; const today = new Date();
        
        window.dbCache.forEach(d => {
            if(d.finanzas.prox_pago && d.finanzas.prox_pago !== 'N/A' && d.finanzas.prox_pago !== 'No definida') {
                const payDate = new Date(d.finanzas.prox_pago);
                const diff = Math.ceil((payDate - today) / (1000 * 60 * 60 * 24));
                if(diff >= 0 && diff <= 3) {
                    count++;
                    list.innerHTML += `<div onclick="editarFicha('${d.id}')" class="p-3 bg-rose-50 dark:bg-rose-900/30 border-l-4 border-rose-500 cursor-pointer rounded-xl hover:bg-rose-100 transition-all text-left shadow-sm">
                        <p class="text-[9px] font-black uppercase text-rose-700 italic">Vence en ${diff} d√≠a(s)</p>
                        <p class="text-xs font-bold text-slate-800 dark:text-slate-200 uppercase">${d.paciente.nombre}</p>
                        <p class="text-[8px] text-slate-500">Saldo: ${d.finanzas.pendiente}</p>
                    </div>`;
                }
            }
        });

        list.innerHTML += `<div onclick="toggleView('appointments')" class="p-3 bg-teal-50 dark:bg-teal-900/30 border-l-4 border-teal-500 cursor-pointer rounded-xl hover:bg-teal-100 transition-all text-left shadow-sm mt-2">
            <p class="text-[9px] font-black uppercase text-teal-700 italic">Central de Citas</p>
            <p class="text-xs font-bold text-slate-800 dark:text-slate-200 uppercase">Monitorear Solicitudes Web</p>
        </div>`;
        document.getElementById('alertCount').innerText = count; 
        document.getElementById('alertCount').classList.toggle('hidden', count === 0);
    };

    window.toggleAlerts = () => document.getElementById('alertBox').classList.toggle('hidden');

    window.marcarComoPendiente = () => {
        const btn = document.getElementById('btnSave');
        if(btn.innerText.includes("LISTO")) {
            btn.innerHTML = '<i class="fas fa-save mr-3 text-teal-400"></i> GUARDAR EXPEDIENTE';
            btn.classList.remove('bg-emerald-600');
            btn.classList.add('bg-slate-900');
        }
    };

    document.getElementById('btnSave').addEventListener('click', async () => {
    const btn = document.getElementById('btnSave');
    
    // REPARACI√ìN: Si el bot√≥n ya est√° bloqueado o ya termin√≥ con √©xito, no hace nada m√°s.
    if (btn.disabled || btn.innerText.includes("LISTO")) return;

    const nom = document.getElementById('nombre').value;
    const fReal = document.getElementById('fecha_inicio_real').value;
    const legal = document.getElementById('check_legal').checked;
    
    if(!nom || !fReal || !legal) return alert("‚ö†Ô∏è ERROR: Nombre, Fecha y T√©rminos son obligatorios.");
    
    // REPARACI√ìN: Bloqueamos el bot√≥n y cambiamos el texto al instante
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i> GUARDANDO...';
    
    // Aqu√≠ contin√∫a tu c√≥digo normal definiendo la variable 'const data = {'
        
        const serv = []; 
        document.querySelectorAll('.service-row').forEach(r => {
            const t = r.querySelector('.s-type').value, p = r.querySelector('.s-price').value;
            if(t && p) serv.push({ tipo: t, zona: r.querySelector('.s-zone').value, precio: p });
        });
        
        const fCuotas = Array.from(document.querySelectorAll('.f-cuota')).map(i => i.value);
        const cobrado = window.historialLocal.reduce((acc, curr) => acc + parseFloat(curr.monto), 0);
        const data = {
            paciente: { 
                nombre: nom, 
                email: (document.getElementById('email_paciente') || {}).value || '', 
                celular: document.getElementById('telefono').value, 
                cedula: document.getElementById('cedula').value, 
                edad: document.getElementById('edad').value, 
                ocupacion: document.getElementById('ocupacion').value, 
                direccion: document.getElementById('direccion').value 
            },
            servicios: serv,
            finanzas: { total: document.getElementById('lblTotal').innerText, abono: cobrado, pendiente: document.getElementById('lblPendiente').innerText, descuento_pct: document.getElementById('descuento_pct').value, bono: document.getElementById('bono_manual').value, usa_cuotas: document.getElementById('usa_cuotas').checked, num_cuotas: document.getElementById('num_cuotas').value, fechas_cuotas: fCuotas, prox_pago: document.getElementById('fecha_proximo_pago_auto').value },
            historial: window.historialLocal, 
            fecha_inicio: fReal, 
            fecha: Timestamp.now(), 
            folio: document.querySelector('.folio-display').innerText, 
            observaciones: document.getElementById('observaciones').value 
        };
        
        try {
            if(window.currentDocId) await updateDoc(doc(db, colName, window.currentDocId), data);
            else await addDoc(collection(db, colName), data);
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-circle mr-3"></i> ¬°LISTO!';
            btn.classList.remove('bg-slate-900');
            btn.classList.add('bg-emerald-600');
            
        } catch(e) { 
            alert("Error de red."); 
            btn.disabled = false; 
            btn.innerText = "GUARDAR EXPEDIENTE"; 
        }
    });

    document.getElementById('btnPdf').addEventListener('click', () => {
        const opt = { margin: 0, filename: `Ficha_${document.getElementById('nombre').value}.pdf`, html2canvas: { scale: 3 }, jsPDF: { unit: 'in', format: 'letter' } };
        html2pdf().set(opt).from(document.getElementById('printContainer')).save();
    });

    let canvas, ctx, isDrawing = false;
    function setupCanvas() {
        canvas = document.getElementById('signaturePad'); 
        if(!canvas) return;
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; ctx.lineWidth = 2.5;
        const start = (e) => { isDrawing = true; ctx.beginPath(); const r = canvas.getBoundingClientRect(); ctx.moveTo((e.clientX || e.touches[0].clientX)-r.left, (e.clientY || e.touches[0].clientY)-r.top); };
        const move = (e) => { if(!isDrawing) return; e.preventDefault(); const r = canvas.getBoundingClientRect(); ctx.lineTo((e.clientX || e.touches[0].clientX)-r.left, (e.clientY || e.touches[0].clientY)-r.top); ctx.stroke(); };
        const stop = () => isDrawing = false;
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', stop);
        canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', stop);
        
        document.getElementById('seccionFormulario').addEventListener('input', marcarComoPendiente);
        document.getElementById('seccionFormulario').addEventListener('change', marcarComoPendiente);
    }
    window.clearSignature = () => ctx && ctx.clearRect(0,0,canvas.width,canvas.height);
    </script>
</body>
</html>
