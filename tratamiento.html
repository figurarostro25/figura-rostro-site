<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Clínico Multi-Servicio | Figura Rostro KG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a', // Slate 900
                        panel: '#1e293b', // Slate 800
                        accent: '#e11d48', // Rose 600
                        input: '#334155', // Slate 700
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        .input-dark {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: white;
            border-radius: 0.5rem;
            padding: 0.6rem;
            width: 100%;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .input-dark:focus { outline: none; border-color: #e11d48; }

        /* Estilo para fila de servicio */
        .service-row {
            background-color: #1a2436;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #334155;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 30px;
            gap: 10px;
            align-items: center;
        }
        @media (max-width: 768px) {
            .service-row { grid-template-columns: 1fr; position: relative; }
            .btn-remove { position: absolute; top: 5px; right: 5px; }
        }

        /* Checkbox */
        .custom-check { accent-color: #e11d48; width: 1.1rem; height: 1.1rem; cursor: pointer; }

        /* Loader */
        .loader { border: 3px solid #334155; border-top: 3px solid #e11d48; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Print */
        @media print {
            body { background-color: #0f172a !important; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .service-row { border: none; padding: 0; margin-bottom: 5px; background: transparent; }
            .btn-remove { display: none; }
            input, select { border: none !important; background: transparent !important; padding: 0; }
        }
    </style>
</head>
<body class="p-2 md:p-6 min-h-screen">

    <nav class="flex justify-between items-center mb-6 max-w-5xl mx-auto no-print">
        <div class="flex items-center gap-3">
            <a href="/" class="text-gray-400 hover:text-white transition"><i class="fas fa-chevron-left"></i> Volver</a>
            <span class="font-bold text-rose-500">SISTEMA PRO v3.0</span>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleView('form')" class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-2 rounded text-sm font-bold shadow-lg transition">
                <i class="fas fa-plus mr-1"></i> Nueva Ficha
            </button>
            <button onclick="toggleView('list')" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded text-sm font-bold transition">
                <i class="fas fa-database mr-1"></i> Consultar
            </button>
        </div>
    </nav>

    <div id="viewForm" class="max-w-5xl mx-auto bg-slate-900 rounded-xl shadow-2xl border border-slate-800 p-6 md:p-8 relative">
        
        <div class="flex justify-between items-end border-b border-slate-700 pb-4 mb-6">
            <div>
                <h1 class="text-2xl font-extrabold text-white uppercase tracking-wider">Figura Rostro KG</h1>
                <p class="text-rose-500 text-xs font-bold tracking-widest">ESTÉTICA INTEGRAL AVANZADA</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400">FECHA DE REGISTRO</p>
                <p id="fechaHoy" class="text-lg font-bold text-white"></p>
            </div>
        </div>

        <form id="clinicalForm">
            
            <h3 class="text-gray-400 text-xs font-bold uppercase mb-4 border-b border-slate-800 pb-2"><i class="fas fa-user mr-2"></i>Datos Personales</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Nombre Completo</label>
                    <input type="text" id="nombre" class="input-dark focus:ring-1 ring-rose-500" placeholder="Ej. María Pérez" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Cédula</label>
                        <input type="text" id="cedula" class="input-dark" placeholder="V-...">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Teléfono</label>
                        <input type="tel" id="telefono" class="input-dark">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Fecha de Nacimiento</label>
                    <div class="flex gap-2">
                        <select id="dia_nac" class="input-dark w-20" onchange="calcularEdad()">
                            <option value="">Día</option>
                            <script>for(let i=1;i<=31;i++) document.write(`<option value="${i}">${i}</option>`);</script>
                        </select>
                        <select id="mes_nac" class="input-dark flex-1" onchange="calcularEdad()">
                            <option value="">Mes</option>
                            <option value="1">Enero</option> <option value="2">Febrero</option>
                            <option value="3">Marzo</option> <option value="4">Abril</option>
                            <option value="5">Mayo</option> <option value="6">Junio</option>
                            <option value="7">Julio</option> <option value="8">Agosto</option>
                            <option value="9">Septiembre</option> <option value="10">Octubre</option>
                            <option value="11">Noviembre</option> <option value="12">Diciembre</option>
                        </select>
                        <input type="number" id="anio_nac" class="input-dark w-24" placeholder="Año" onchange="calcularEdad()">
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Edad</label>
                        <input type="text" id="edad" class="input-dark bg-slate-800 text-center font-bold text-rose-400" readonly placeholder="--">
                    </div>
                    <div class="w-2/3">
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Ocupación</label>
                        <input type="text" id="ocupacion" class="input-dark">
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Dirección</label>
                <input type="text" id="direccion" class="input-dark">
            </div>

            <div class="flex justify-between items-end mb-2 border-b border-slate-800 pb-2">
                <h3 class="text-gray-400 text-xs font-bold uppercase"><i class="fas fa-list mr-2"></i>Tratamientos Realizados</h3>
                <button type="button" onclick="agregarServicio()" class="text-xs bg-slate-700 hover:bg-slate-600 text-green-400 px-3 py-1 rounded transition no-print">
                    <i class="fas fa-plus-circle"></i> Agregar Otro Servicio
                </button>
            </div>

            <div id="listaServicios" class="mb-6">
                </div>

            <div class="bg-slate-800 p-5 rounded-lg border border-slate-700 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">1. Subtotal Servicios</label>
                            <input type="text" id="subtotal" class="input-dark font-mono text-right" readonly value="$0.00">
                        </div>

                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase flex justify-between">
                                <span>2. Descuento Promocional (%)</span>
                                <span class="text-rose-400 text-[10px] cursor-pointer" onclick="resetDesc()">[Borrar]</span>
                            </label>
                            <div class="flex gap-1 mb-1">
                                <button type="button" onclick="setPromo(0.10)" class="flex-1 bg-slate-700 text-[10px] py-1 rounded hover:bg-slate-600 text-gray-300">10%</button>
                                <button type="button" onclick="setPromo(0.20)" class="flex-1 bg-slate-700 text-[10px] py-1 rounded hover:bg-slate-600 text-gray-300">20%</button>
                                <button type="button" onclick="setPromo(0.30)" class="flex-1 bg-slate-700 text-[10px] py-1 rounded hover:bg-slate-600 text-rose-300 font-bold">30%</button>
                            </div>
                            <input type="hidden" id="promo_pct" value="0"> <input type="text" id="descuento_valor" class="input-dark font-mono text-right text-yellow-500" readonly value="- $0.00">
                        </div>

                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">3. Bono Gift Card / Extra ($)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-yellow-500 text-xs">- $</span>
                                <input type="number" id="bono_extra" class="input-dark pl-8 font-mono text-right text-yellow-400" placeholder="0" oninput="calcularTotal()">
                            </div>
                            <p class="text-[10px] text-gray-500 mt-1">* Se suma al descuento porcentual</p>
                        </div>
                    </div>

                    <div class="bg-slate-900 p-4 rounded border border-slate-800 flex flex-col justify-between">
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">TOTAL A PAGAR</label>
                            <div id="lblTotal" class="text-3xl font-bold text-white text-right mb-4">$0.00</div>
                        </div>

                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Abono Realizado Hoy</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-green-500 text-xs">$</span>
                                <input type="number" id="abono" class="input-dark pl-6 font-bold text-green-400 text-right text-lg" placeholder="0" oninput="calcularTotal()">
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-700 text-right">
                            <span class="text-xs text-gray-500 uppercase font-bold">Saldo Pendiente</span>
                            <div id="lblPendiente" class="text-2xl font-bold text-rose-500">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex flex-wrap gap-4 text-xs text-gray-300">
                    <label class="flex items-center"><input type="checkbox" id="m_diabetes" class="custom-check mr-2"> Diabetes</label>
                    <label class="flex items-center"><input type="checkbox" id="m_hipertension" class="custom-check mr-2"> Hipertensión</label>
                    <label class="flex items-center"><input type="checkbox" id="m_alergias" class="custom-check mr-2"> Alergias</label>
                    <label class="flex items-center"><input type="checkbox" id="m_embarazo" class="custom-check mr-2"> Embarazo</label>
                    <label class="flex items-center"><input type="checkbox" id="m_keloides" class="custom-check mr-2"> Cicatriz. Keloide</label>
                </div>
            </div>

            <div class="bg-slate-800 p-3 rounded mb-6">
                <div class="h-20 overflow-y-auto text-[10px] text-gray-500 text-justify pr-2 leading-relaxed">
                    <p><strong>CONSENTIMIENTO INFORMADO:</strong> Certifico que la información suministrada es verídica. Entiendo los riesgos del tratamiento y autorizo a Figura Rostro KG a realizarlo. Comprendo que los resultados varían según el paciente. Autorizo el registro fotográfico para expediente clínico privado. Eximo de responsabilidad al local por cuidados post-tratamiento inadecuados.</p>
                </div>
                <div class="mt-2">
                    <label class="flex items-center text-xs cursor-pointer hover:text-white">
                        <input type="checkbox" id="check_legal" class="custom-check mr-2"> Acepto los términos y condiciones.
                    </label>
                </div>
            </div>

            <div class="flex gap-3 no-print">
                <button type="button" id="btnSave" class="flex-1 bg-gradient-to-r from-rose-700 to-rose-600 text-white py-3 rounded hover:shadow-lg hover:shadow-rose-900/50 transition font-bold">
                    <i class="fas fa-save mr-2"></i> GUARDAR FICHA
                </button>
                <button type="button" id="btnPdf" class="w-1/3 border border-slate-600 bg-slate-800 text-gray-300 py-3 rounded hover:bg-slate-700 transition font-bold">
                    <i class="fas fa-print mr-2"></i> PDF
                </button>
            </div>

        </form>
    </div>

    <div id="viewList" class="hidden max-w-6xl mx-auto">
        <div class="bg-slate-900 rounded-xl shadow-lg border border-slate-800 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-white font-bold text-lg">Historial de Pacientes</h2>
                <button onclick="loadData()" class="text-xs text-blue-400 hover:text-blue-300"><i class="fas fa-sync mr-1"></i> Actualizar</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-500 uppercase bg-slate-800">
                        <tr>
                            <th class="px-4 py-3">Fecha</th>
                            <th class="px-4 py-3">Paciente</th>
                            <th class="px-4 py-3">Servicios</th>
                            <th class="px-4 py-3 text-right">Total</th>
                            <th class="px-4 py-3 text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div id="loader" class="hidden text-center py-8"><div class="loader mx-auto"></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================
        // --- TUS LLAVES CONFIGURADAS CORRECTAMENTE ---
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBAuTfBKGuG33c9NXc1s0lkQv-7GwA47l0",
            authDomain: "figurarostro-system.firebaseapp.com",
            projectId: "figurarostro-system",
            storageBucket: "figurarostro-system.firebasestorage.app",
            messagingSenderId: "803848354693",
            appId: "1:803848354693:web:7144490abb18b0319822ec"
        };
        // --------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colName = "fichas_v3_multi";

        // INICIALIZACIÓN
        document.getElementById('fechaHoy').innerText = new Date().toLocaleDateString();
        
        // Agregar primer servicio al cargar
        window.addEventListener('load', () => { agregarServicio(); });

        // NAVEGACIÓN
        window.toggleView = (view) => {
            document.getElementById('viewForm').classList.toggle('hidden', view !== 'form');
            document.getElementById('viewList').classList.toggle('hidden', view !== 'list');
            if(view === 'list') loadData();
        };

        // ----------------------------------------------------
        // LÓGICA DE SERVICIOS DINÁMICOS
        // ----------------------------------------------------
        window.agregarServicio = function() {
            const container = document.getElementById('listaServicios');
            const id = Date.now();
            
            const html = `
                <div class="service-row" id="row-${id}">
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Tratamiento</label>
                        <select class="input-dark bg-slate-800 s-type" onchange="checkZone(this)">
                            <option value="Plasma Fibroblast">Plasma Fibroblast</option>
                            <option value="Limpieza Facial">Limpieza Facial</option>
                            <option value="Dermapen">Dermapen</option>
                            <option value="Hidratación">Hidratación</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Zona (Opcional)</label>
                        <input type="text" class="input-dark s-zone" placeholder="Ej. Párpados">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Precio ($)</label>
                        <input type="number" class="input-dark text-right font-bold s-price" placeholder="0" oninput="calcularTotal()">
                    </div>
                    <div class="text-center pt-4">
                        <button type="button" onclick="eliminarServicio('${id}')" class="text-rose-500 hover:text-rose-400 btn-remove" title="Eliminar fila">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        window.eliminarServicio = function(id) {
            const rows = document.querySelectorAll('.service-row');
            if(rows.length > 1) {
                document.getElementById(`row-${id}`).remove();
                calcularTotal();
            } else {
                alert("Debe haber al menos un servicio.");
            }
        }

        window.checkZone = function(select) {
            // Lógica simple: si es limpieza, sugerimos borrar zona, pero dejamos libre albedrío
            const row = select.closest('.service-row');
            const zoneInput = row.querySelector('.s-zone');
            if(!select.value.includes('Fibroblast') && !select.value.includes('Otro')) {
                zoneInput.value = ''; 
                zoneInput.placeholder = 'N/A';
            } else {
                zoneInput.placeholder = 'Ej. Párpados';
            }
        }

        // ----------------------------------------------------
        // LÓGICA MATEMÁTICA "ULTIMATE"
        // ----------------------------------------------------
        window.setPromo = function(pct) {
            document.getElementById('promo_pct').value = pct;
            calcularTotal();
        }
        window.resetDesc = function() {
            document.getElementById('promo_pct').value = 0;
            calcularTotal();
        }

        window.calcularTotal = function() {
            // 1. Sumar Precios Individuales
            let subtotal = 0;
            document.querySelectorAll('.s-price').forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });

            // 2. Calcular Descuento %
            const pct = parseFloat(document.getElementById('promo_pct').value) || 0;
            const descuentoValor = subtotal * pct;

            // 3. Obtener Bono Gift Card
            const bonoExtra = parseFloat(document.getElementById('bono_extra').value) || 0;

            // 4. Total Final = Subtotal - Descuento% - BonoExtra
            const total = subtotal - descuentoValor - bonoExtra;

            // 5. Saldo Pendiente
            const abono = parseFloat(document.getElementById('abono').value) || 0;
            const pendiente = total - abono;

            // Renderizar
            document.getElementById('subtotal').value = "$" + subtotal.toFixed(2);
            document.getElementById('descuento_valor').value = `- $${descuentoValor.toFixed(2)} (${pct*100}%)`;
            
            document.getElementById('lblTotal').innerText = "$" + total.toFixed(2);
            
            const elPend = document.getElementById('lblPendiente');
            elPend.innerText = "$" + pendiente.toFixed(2);
            
            if(pendiente <= 0.01 && total > 0) {
                elPend.className = "text-2xl font-bold text-green-400";
                elPend.innerText = "PAGADO";
            } else {
                elPend.className = "text-2xl font-bold text-rose-500";
            }
        }

        // ----------------------------------------------------
        // EDAD (3 PASOS)
        // ----------------------------------------------------
        window.calcularEdad = function() {
            const d = document.getElementById('dia_nac').value;
            const m = document.getElementById('mes_nac').value;
            const y = document.getElementById('anio_nac').value;

            if(d && m && y && y.length === 4) {
                const hoy = new Date();
                const cumple = new Date(y, m-1, d);
                let edad = hoy.getFullYear() - cumple.getFullYear();
                const mDiff = hoy.getMonth() - cumple.getMonth();
                if (mDiff < 0 || (mDiff === 0 && hoy.getDate() < cumple.getDate())) {
                    edad--;
                }
                document.getElementById('edad').value = edad + " años";
            }
        }

        // ----------------------------------------------------
        // GUARDAR EN FIREBASE
        // ----------------------------------------------------
        document.getElementById('btnSave').addEventListener('click', async () => {
            const btn = document.getElementById('btnSave');
            const nombre = document.getElementById('nombre').value;
            const legal = document.getElementById('check_legal').checked;

            if(!nombre) return alert("Falta Nombre");
            if(!legal) return alert("Falta aceptar términos");

            // Recopilar lista de servicios
            let listaServicios = [];
            document.querySelectorAll('.service-row').forEach(row => {
                listaServicios.push({
                    tipo: row.querySelector('.s-type').value,
                    zona: row.querySelector('.s-zone').value,
                    precio: row.querySelector('.s-price').value
                });
            });

            btn.innerHTML = "Guardando...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, colName), {
                    paciente: {
                        nombre: nombre,
                        cedula: document.getElementById('cedula').value,
                        telefono: document.getElementById('telefono').value,
                        nacimiento: `${document.getElementById('dia_nac').value}/${document.getElementById('mes_nac').value}/${document.getElementById('anio_nac').value}`,
                        edad: document.getElementById('edad').value,
                        ocupacion: document.getElementById('ocupacion').value,
                        direccion: document.getElementById('direccion').value
                    },
                    servicios: listaServicios, // Array de objetos
                    finanzas: {
                        subtotal: document.getElementById('subtotal').value,
                        descuento_pct: document.getElementById('promo_pct').value,
                        bono_extra: document.getElementById('bono_extra').value,
                        total: document.getElementById('lblTotal').innerText,
                        abono: document.getElementById('abono').value,
                        pendiente: document.getElementById('lblPendiente').innerText
                    },
                    medico: {
                        diabetes: document.getElementById('m_diabetes').checked,
                        // ... agregar resto si necesario para estadística
                    },
                    fecha: Timestamp.now()
                });
                
                alert("✅ GUARDADO CORRECTAMENTE");
                location.reload(); // Recargar para limpiar todo seguro
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
                btn.innerHTML = "Guardar Ficha";
                btn.disabled = false;
            }
        });

        // ----------------------------------------------------
        // LEER DATOS (Renderizar tabla compleja)
        // ----------------------------------------------------
        window.loadData = async () => {
            const tbody = document.getElementById('tableBody');
            const loader = document.getElementById('loader');
            tbody.innerHTML = '';
            loader.classList.remove('hidden');

            const q = query(collection(db, colName), orderBy("fecha", "desc"));
            const snap = await getDocs(q);
            loader.classList.add('hidden');

            snap.forEach(doc => {
                const d = doc.data();
                
                // Formatear servicios en HTML pequeño
                let serviciosHTML = d.servicios.map(s => 
                    `<div class='text-xs'>• ${s.tipo} ${s.zona ? `(${s.zona})` : ''}</div>`
                ).join('');

                const row = `
                    <tr class="border-b border-slate-800 hover:bg-slate-800 transition">
                        <td class="px-4 py-3">${d.fecha.toDate().toLocaleDateString()}</td>
                        <td class="px-4 py-3 font-bold text-white">${d.paciente.nombre}</td>
                        <td class="px-4 py-3 text-gray-400">${serviciosHTML}</td>
                        <td class="px-4 py-3 text-right text-white font-mono">${d.finanzas.total}</td>
                        <td class="px-4 py-3 text-center">
                            ${d.finanzas.pendiente.includes('PAGADO') 
                                ? '<span class="bg-green-900 text-green-300 text-[10px] px-2 py-1 rounded">OK</span>' 
                                : '<span class="text-rose-400 font-bold text-[10px]">DEBE</span>'}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ----------------------------------------------------
        // PDF PRO (Modo Tinta Económica / Fondo Blanco)
        // ----------------------------------------------------
        // He mejorado esta función para que imprima en blanco y ahorre tinta
        document.getElementById('btnPdf').addEventListener('click', () => {
            const element = document.getElementById('viewForm');
            
            // 1. GUARDAR ESTADO ORIGINAL
            const originalClasses = element.className;
            const inputs = element.querySelectorAll('input, select, textarea');
            const texts = element.querySelectorAll('.text-white, .text-gray-300, .text-gray-400, .text-gray-500');

            // 2. MODO IMPRESIÓN (CAMBIO TEMPORAL A BLANCO)
            element.classList.remove('bg-slate-900', 'text-white');
            element.classList.add('bg-white', 'text-black');

            inputs.forEach(input => {
                input.dataset.originalBg = input.style.backgroundColor;
                input.dataset.originalColor = input.style.color;
                input.dataset.originalBorder = input.style.border;
                
                input.style.backgroundColor = '#ffffff';
                input.style.color = '#000000';
                input.style.border = '1px solid #ccc';
            });

            texts.forEach(t => {
                t.dataset.originalClass = t.className;
                t.classList.remove('text-white', 'text-gray-300', 'text-gray-400', 'text-gray-500');
                t.classList.add('text-black');
            });

            const controls = document.querySelectorAll('.no-print');
            controls.forEach(c => c.style.display = 'none');

            // 3. GENERAR
            const opt = {
                margin: [0.3, 0.3],
                filename: `Ficha_${document.getElementById('nombre').value || 'Paciente'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: "#ffffff", useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // 4. RESTAURAR (MODO OSCURO)
                element.className = originalClasses;

                inputs.forEach(input => {
                    input.style.backgroundColor = input.dataset.originalBg || '';
                    input.style.color = input.dataset.originalColor || '';
                    input.style.border = input.dataset.originalBorder || '';
                });

                texts.forEach(t => {
                    t.className = t.dataset.originalClass;
                });

                controls.forEach(c => c.style.display = '');
            });
        });

    </script>
</body>
</html>
