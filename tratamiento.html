<!DOCTYPE html>
<html lang="es" class="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Clínico | Figura Rostro KG</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // Permite activar el modo oscuro manualmente con un botón
            theme: {
                extend: {
                    colors: {
                        // Paleta de Marca (Morados y Fucsias)
                        brand: {
                            dark: '#4a044e',    /* Morado muy oscuro */
                            main: '#9333ea',    /* Morado vibrante */
                            light: '#e879f9',   /* Fucsia claro */
                            accent: '#d946ef',  /* Fucsia neón */
                        },
                        // Paleta Modo Oscuro (Dark Mode)
                        night: {
                            bg: '#0f172a',      /* Fondo principal Slate-900 */
                            card: '#1e293b',    /* Fondo tarjetas Slate-800 */
                            input: '#334155',   /* Fondo inputs Slate-700 */
                            border: '#475569',  /* Bordes Slate-600 */
                        }
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Transiciones suaves al cambiar de modo día/noche */
        body, div, nav, input, select, button, span, p, h1, h2 {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* FONDO GENERAL */
        body {
            @apply bg-fuchsia-50 text-gray-700; /* Modo Día */
        }
        .dark body {
            background-color: #0f172a; /* Modo Noche */
            color: #e2e8f0;
        }
        
        /* ESTILO DE LOS INPUTS (Cuadros de texto) */
        .input-pro {
            width: 100%;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            outline: none;
            /* Estilo Día */
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            color: #1e293b;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Estilo Noche (Inputs) */
        .dark .input-pro {
            background-color: #334155;
            border: 1px solid #475569;
            color: #ffffff;
        }
        
        /* Foco (Click) */
        .input-pro:focus {
            border-color: #d946ef;
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.2);
        }

        /* ETIQUETAS (Labels) */
        .label-pro {
            display: block;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
            /* Color Día/Noche */
            color: #4a044e; 
        }
        .dark .label-pro {
            color: #e879f9; /* Fucsia claro en modo oscuro */
        }

        /* FILAS DE LA TABLA DE SERVICIOS */
        .service-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 40px;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            /* Día */
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        .dark .service-row {
            /* Noche */
            background-color: #1e293b;
            border: 1px solid #475569;
        }

        /* TÍTULOS DE SECCIÓN */
        .section-header {
            font-size: 12px;
            font-weight: 900;
            text-transform: uppercase;
            padding-bottom: 6px;
            margin-top: 24px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom-width: 2px;
            /* Día */
            color: #9333ea;
            border-color: #f0abfc;
        }
        .dark .section-header {
            /* Noche */
            color: #d946ef;
            border-color: #475569;
        }

        /* CHECKBOX */
        .custom-check {
            accent-color: #d946ef;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* LOADER (Animación de carga) */
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #d946ef;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- REGLAS CRÍTICAS PARA IMPRESIÓN (PDF) --- */
        /* Esto asegura que el PDF salga BLANCO aunque uses Modo Oscuro */
        @media print {
            body { background-color: white !important; color: black !important; }
            .dark { color-scheme: light; } /* Fuerza modo claro */
            .no-print { display: none !important; } /* Oculta botones */
            
            /* Resetea colores de inputs para impresión */
            .input-pro { 
                background-color: white !important; 
                border: 1px solid #ccc !important; 
                color: black !important; 
            }
            .dark .input-pro {
                background-color: white !important;
                color: black !important;
            }
            
            /* Elimina sombras */
            .shadow-2xl, .shadow-lg, .shadow-md { box-shadow: none !important; }
            
            /* Mantiene el header morado bonito */
            .header-gradient { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                color: white !important;
            }
        }
    </style>
</head>
<body class="p-4 flex justify-center min-h-screen">

    <nav class="fixed top-0 inset-x-0 bg-white/90 dark:bg-night-card/90 backdrop-blur shadow-md p-3 z-50 border-b border-gray-200 dark:border-slate-700 no-print">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-500 dark:text-gray-300 hover:text-brand-main font-bold text-xs flex items-center gap-1 transition">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                
                <button onclick="toggleDarkMode()" class="flex items-center gap-2 bg-gray-100 dark:bg-slate-700 px-3 py-1.5 rounded-full text-xs font-bold text-gray-600 dark:text-yellow-400 hover:scale-105 transition border border-gray-200 dark:border-slate-600">
                    <i class="fas fa-sun dark:hidden"></i> <i class="fas fa-moon hidden dark:inline"></i> <span class="dark:hidden">Modo Día</span>
                    <span class="hidden dark:inline">Modo Noche</span>
                </button>
            </div>

            <div class="flex gap-2">
                <button onclick="limpiarFormulario()" class="bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-900 dark:bg-slate-800 dark:text-fuchsia-300 dark:hover:bg-slate-700 px-4 py-2 rounded-full text-xs font-bold border border-fuchsia-200 dark:border-slate-600 transition flex items-center">
                    <i class="fas fa-file-medical mr-2"></i> Nueva Ficha
                </button>
                <button onclick="toggleView('list')" class="bg-brand-main hover:bg-brand-dark text-white px-4 py-2 rounded-full text-xs font-bold transition flex items-center shadow-lg shadow-purple-500/30">
                    <i class="fas fa-database mr-2"></i> Consultar BD
                </button>
            </div>
        </div>
    </nav>
    
    <div class="h-16 no-print"></div>

    <div id="viewForm" class="w-full max-w-4xl bg-white dark:bg-night-card shadow-2xl rounded-2xl border border-gray-200 dark:border-slate-700 relative overflow-hidden mb-10 transition-colors duration-300">
        
        <div class="header-gradient bg-gradient-to-r from-brand-dark via-brand-main to-brand-dark p-8 flex justify-between items-start relative text-white">
            
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
            
            <div class="relative z-10">
                
                <div class="mb-4">
                    <div class="h-14 w-44 border-2 border-dashed border-white/20 rounded-lg flex items-center justify-center bg-white/5 backdrop-blur-sm">
                        <span class="text-[9px] text-white/60 font-bold tracking-widest text-center">
                            [ LOGO BLANCO ]
                        </span>
                    </div>
                </div>
                <h1 class="text-3xl font-black uppercase tracking-wider drop-shadow-lg">Figura Rostro KG</h1>
                <p class="text-fuchsia-200 text-[10px] font-bold tracking-[0.2em] uppercase mt-2 border-t border-white/10 pt-2 inline-block">
                    Especialistas en Rejuvenecimiento No Invasivo
                </p>
            </div>

            <div class="text-right flex flex-col items-end relative z-10">
                <div class="mb-4 text-purple-100 opacity-90">
                    <p class="text-[9px] uppercase mb-0.5 font-bold">Fecha de Emisión</p>
                    <div class="text-xs font-bold bg-white/10 px-3 py-1 rounded inline-block" id="fechaHoy"></div>
                </div>
                
                <div class="bg-white/95 text-brand-dark px-4 py-2 rounded-lg shadow-xl border-l-4 border-fuchsia-500">
                    <p class="text-[8px] uppercase text-gray-500 mb-0 font-bold">Solicitud N°</p>
                    <div class="text-2xl font-black font-mono tracking-widest" id="folioDisplay">...</div>
                </div>
            </div>
        </div>

        <div class="p-8 md:p-10 relative">
            
            <form id="clinicalForm">
                
                <div class="section-header mt-0">
                    <i class="fas fa-user-circle text-lg"></i> Información del Paciente
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="label-pro">Nombre Completo</label>
                        <input type="text" id="nombre" class="input-pro border-l-4 border-l-brand-main" placeholder="Ej. Ana María Pérez" required>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div>
                            <label class="label-pro">Cédula / ID</label>
                            <input type="text" id="cedula" class="input-pro">
                        </div>
                        <div>
                            <label class="label-pro">Teléfono</label>
                            <input type="tel" id="telefono" class="input-pro">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="label-pro">Fecha Nacimiento</label>
                        <div class="flex gap-3">
                            <select id="dia_nac" class="input-pro w-20 cursor-pointer" onchange="calcularEdad()">
                                <option value="">Día</option>
                                <script>for(let i=1;i<=31;i++) document.write(`<option value="${i}">${i}</option>`);</script>
                            </select>
                            <select id="mes_nac" class="input-pro flex-1 cursor-pointer" onchange="calcularEdad()">
                                <option value="">Mes</option>
                                <option value="1">Enero</option> <option value="2">Febrero</option> <option value="3">Marzo</option>
                                <option value="4">Abril</option> <option value="5">Mayo</option> <option value="6">Junio</option>
                                <option value="7">Julio</option> <option value="8">Agosto</option> <option value="9">Septiembre</option>
                                <option value="10">Octubre</option> <option value="11">Noviembre</option> <option value="12">Diciembre</option>
                            </select>
                            <input type="number" id="anio_nac" class="input-pro w-24" placeholder="Año" onchange="calcularEdad()">
                        </div>
                    </div>
                    <div class="flex gap-5">
                        <div class="w-24">
                            <label class="label-pro">Edad</label>
                            <input type="text" id="edad" class="input-pro bg-fuchsia-50 dark:bg-slate-800 text-center font-bold text-brand-main" readonly>
                        </div>
                        <div class="flex-1">
                            <label class="label-pro">Ocupación</label>
                            <input type="text" id="ocupacion" class="input-pro">
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <label class="label-pro">Dirección</label>
                    <input type="text" id="direccion" class="input-pro" placeholder="Dirección de habitación...">
                </div>

                <div class="flex justify-between items-end border-b-2 border-fuchsia-100 dark:border-slate-700 pb-2 mt-8 mb-4">
                    <div class="section-header border-0 m-0 w-full">
                        <i class="fas fa-spa text-lg"></i> Tratamientos
                    </div>
                    <button type="button" onclick="agregarServicio()" class="text-[10px] whitespace-nowrap bg-fuchsia-50 hover:bg-fuchsia-100 text-fuchsia-900 border border-fuchsia-200 dark:bg-slate-700 dark:text-white dark:border-slate-600 px-4 py-2 rounded-full transition no-print font-bold flex items-center shadow-sm">
                        <i class="fas fa-plus text-green-500 mr-2"></i> AGREGAR
                    </button>
                </div>

                <div id="listaServicios" class="mb-10 min-h-[50px]">
                    </div>

                <div class="bg-gray-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-gray-200 dark:border-slate-600 mb-8 shadow-inner">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="label-pro text-gray-500 dark:text-gray-400">Subtotal</label>
                                <input type="text" id="subtotal" class="input-pro w-32 text-right bg-transparent border-none font-bold text-gray-500 dark:text-gray-300" readonly value="$0.00">
                            </div>
                            
                            <hr class="border-gray-200 dark:border-slate-600">
                            
                            <div class="flex justify-between items-center">
                                <label class="label-pro text-brand-main dark:text-fuchsia-400">Descuento (%)</label>
                                <div class="flex gap-1">
                                    <button type="button" onclick="setPromo(0.10)" class="w-9 py-1 text-[10px] bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded font-bold hover:bg-fuchsia-100 transition dark:text-white">10%</button>
                                    <button type="button" onclick="setPromo(0.20)" class="w-9 py-1 text-[10px] bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded font-bold hover:bg-fuchsia-100 transition dark:text-white">20%</button>
                                    <button type="button" onclick="setPromo(0.30)" class="w-9 py-1 text-[10px] bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded font-bold hover:bg-fuchsia-100 transition dark:text-white">30%</button>
                                    <button type="button" onclick="resetDesc()" class="text-red-400 px-2 font-bold hover:text-red-600" title="Borrar Descuento"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <input type="hidden" id="promo_pct" value="0">
                            <div class="text-right text-[11px] text-brand-light font-mono font-bold" id="descuento_txt"></div>

                            <div class="flex justify-between items-center pt-2">
                                <label class="label-pro text-brand-main dark:text-fuchsia-400">Bono Extra ($)</label>
                                <input type="number" id="bono_extra" class="input-pro w-32 text-right border-fuchsia-200 dark:border-slate-500 text-brand-main dark:text-fuchsia-300 font-bold" placeholder="0.00" oninput="calcularTotal()">
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-900 p-5 border-2 border-fuchsia-50 dark:border-slate-600 rounded-xl shadow-lg flex flex-col justify-between relative overflow-hidden">
                            
                            <div class="flex justify-between items-end mb-4 relative z-10">
                                <span class="text-xs font-bold text-gray-400 uppercase">Total a Pagar</span>
                                <span id="lblTotal" class="text-3xl font-black text-gray-800 dark:text-white font-mono">$0.00</span>
                            </div>
                            
                            <div class="flex justify-between items-center mb-4 bg-green-50 dark:bg-slate-800 p-3 rounded-lg border border-green-100 dark:border-slate-600 relative z-10">
                                <span class="text-[10px] font-bold text-green-700 uppercase">Abono Hoy ($)</span>
                                <input type="number" id="abono" class="w-28 bg-transparent text-right font-black text-xl text-green-600 outline-none" placeholder="0" oninput="calcularTotal()">
                            </div>

                            <div class="border-t border-dashed border-gray-200 dark:border-slate-600 pt-3 flex justify-between items-end relative z-10">
                                <span class="text-[11px] font-bold text-gray-400 uppercase">Saldo Pendiente</span>
                                <span id="lblPendiente" class="text-2xl font-bold text-rose-500 font-mono">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-header"><i class="fas fa-file-contract"></i> Consentimiento</div>
                
                <div class="mb-6 bg-gray-50 dark:bg-slate-800/50 p-4 border border-gray-200 dark:border-slate-600 rounded-xl">
                    <p class="label-pro mb-3 text-gray-400">Marque antecedentes relevantes:</p>
                    <div class="flex flex-wrap gap-4 text-[10px] text-gray-600 dark:text-gray-300 font-bold uppercase">
                        <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-700 px-2 py-1 rounded border border-gray-100 dark:border-slate-600"><input type="checkbox" id="m_diabetes" class="accent-fuchsia-600 cursor-pointer"> Diabetes</label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-700 px-2 py-1 rounded border border-gray-100 dark:border-slate-600"><input type="checkbox" id="m_hipertension" class="accent-fuchsia-600 cursor-pointer"> Hipertensión</label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-700 px-2 py-1 rounded border border-gray-100 dark:border-slate-600"><input type="checkbox" id="m_alergias" class="accent-fuchsia-600 cursor-pointer"> Alergias</label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-700 px-2 py-1 rounded border border-gray-100 dark:border-slate-600"><input type="checkbox" id="m_embarazo" class="accent-fuchsia-600 cursor-pointer"> Embarazo</label>
                        <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-700 px-2 py-1 rounded border border-gray-100 dark:border-slate-600"><input type="checkbox" id="m_keloides" class="accent-fuchsia-600 cursor-pointer"> Keloide</label>
                    </div>
                </div>

                <div class="border-l-4 border-brand-light pl-5 py-3 text-justify mb-8">
                    <p class="text-[10px] text-gray-500 dark:text-gray-400 leading-relaxed mb-4 font-medium">
                        <strong>TÉRMINOS Y CONDICIONES:</strong> El paciente certifica que la información médica provista es verídica y completa. Autoriza a <strong>Figura Rostro KG</strong> a realizar los procedimientos estéticos acordados y consiente el registro fotográfico para el expediente clínico privado. Entiende que los resultados pueden variar según el organismo y exime al establecimiento de responsabilidad por complicaciones derivadas de un cuidado post-tratamiento inadecuado.
                    </p>
                    <label class="flex items-center gap-3 cursor-pointer group bg-gray-50 dark:bg-slate-800 p-3 rounded-lg border border-gray-200 dark:border-slate-600 w-fit hover:border-brand-light transition">
                        <input type="checkbox" id="check_legal" class="accent-fuchsia-600 w-4 h-4 cursor-pointer"> 
                        <span class="text-[11px] font-bold text-gray-800 dark:text-white group-hover:text-brand-main">HE LEÍDO Y ACEPTO LOS TÉRMINOS.</span>
                    </label>
                </div>

                <div class="flex flex-col md:flex-row gap-5 no-print mt-12 border-t border-gray-200 dark:border-slate-700 pt-8">
                    <button type="button" id="btnSave" class="flex-1 bg-gradient-to-r from-brand-dark to-brand-main text-white py-4 rounded-xl hover:bg-brand-dark transition-all font-bold shadow-lg shadow-fuchsia-900/20 text-sm flex justify-center items-center gap-3 transform hover:-translate-y-1">
                        <i class="fas fa-save text-lg"></i> GUARDAR FICHA
                    </button>
                    <button type="button" id="btnPdf" class="md:w-1/3 bg-white dark:bg-slate-800 text-brand-dark dark:text-white border-2 border-gray-200 dark:border-slate-600 py-4 rounded-xl hover:bg-gray-50 dark:hover:bg-slate-700 transition font-bold text-sm flex justify-center items-center gap-3 transform hover:-translate-y-1">
                        <i class="fas fa-print text-lg text-brand-main"></i> IMPRIMIR PDF
                    </button>
                </div>

            </form>
        </div>
    </div>

    <div id="viewList" class="hidden w-full max-w-5xl bg-white dark:bg-night-card shadow-2xl p-8 mt-16 rounded-2xl border border-gray-200 dark:border-slate-700 relative mb-20">
        <div class="flex justify-between mb-6 border-b border-gray-200 dark:border-slate-600 pb-4">
            <h2 class="font-bold text-xl text-gray-800 dark:text-white">Base de Datos</h2>
            <button onclick="loadData()" class="text-xs bg-gray-100 dark:bg-slate-700 px-4 py-2 rounded-full font-bold dark:text-white border dark:border-slate-600 hover:bg-gray-200 transition">
                <i class="fas fa-sync mr-1"></i> Actualizar
            </button>
        </div>
        
        <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-slate-700">
            <table class="w-full text-xs text-left text-gray-600 dark:text-gray-300">
                <thead class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-white uppercase font-bold">
                    <tr>
                        <th class="p-4">Folio</th>
                        <th class="p-4">Fecha</th>
                        <th class="p-4">Paciente</th>
                        <th class="p-4">Tratamientos</th>
                        <th class="p-4 text-right">Total</th>
                        <th class="p-4 text-center">Estado</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-gray-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                    </tbody>
            </table>
        </div>
        
        <div id="loader" class="hidden text-center py-12">
            <div class="loader mx-auto shadow-lg shadow-purple-200"></div>
            <p class="text-xs text-gray-400 mt-3 font-bold animate-pulse">Cargando...</p>
        </div>
    </div>

    <script type="module">
        // Importamos las funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURACIÓN DE TUS LLAVES (NO TOCAR)
        const firebaseConfig = {
            apiKey: "AIzaSyBAuTfBKGuG33c9NXc1s0lkQv-7GwA47l0",
            authDomain: "figurarostro-system.firebaseapp.com",
            projectId: "figurarostro-system",
            storageBucket: "figurarostro-system.firebasestorage.app",
            messagingSenderId: "803848354693",
            appId: "1:803848354693:web:7144490abb18b0319822ec"
        };

        // Inicializamos la App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colName = "fichas_v3_multi";

        // --- FUNCIÓN: MODO OSCURO (TOGGLE) ---
        window.toggleDarkMode = () => {
            // Agrega o quita la clase "dark" del HTML
            document.documentElement.classList.toggle('dark');
        }

        // --- FUNCIONES INICIALES ---
        // Genera un folio único basado en la hora actual
        const generarFolio = () => { 
            const random = Date.now().toString().slice(-6); 
            document.getElementById('folioDisplay').innerText = `REQ-${random}`; 
        };

        // Poner la fecha de hoy al cargar
        document.getElementById('fechaHoy').innerText = new Date().toLocaleDateString('es-ES', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Evento de carga de página
        window.addEventListener('load', () => { 
            agregarServicio(); 
            generarFolio(); 
        });

        // Limpiar formulario manual
        window.limpiarFormulario = function() { 
            if(confirm("¿Estás segura de querer iniciar una nueva ficha vacía?")) {
                location.reload(); 
            }
        }

        // Cambiar entre vistas (Formulario <-> Base de Datos)
        window.toggleView = (view) => {
            document.getElementById('viewForm').classList.toggle('hidden', view !== 'form');
            document.getElementById('viewList').classList.toggle('hidden', view !== 'list');
            if(view === 'list') loadData();
        };

        // --- LÓGICA DE FILAS DE SERVICIOS ---
        window.agregarServicio = function() {
            const container = document.getElementById('listaServicios');
            const id = Date.now(); // ID único para cada fila
            
            // HTML de la fila nueva
            const html = `
                <div class="service-row" id="row-${id}">
                    <div>
                        <select class="input-pro cursor-pointer s-type font-bold" onchange="checkZone(this)">
                            <option value="Plasma Fibroblast">Plasma Fibroblast</option>
                            <option value="Limpieza Facial">Limpieza Facial</option>
                            <option value="Dermapen">Dermapen</option>
                            <option value="Hidratación">Hidratación</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <input type="text" class="input-pro s-zone" placeholder="Ej. Párpados">
                    </div>
                    <div>
                        <input type="number" class="input-pro text-right font-bold s-price" placeholder="0.00" oninput="calcularTotal()">
                    </div>
                    <div class="text-center pt-1">
                        <button type="button" onclick="eliminarServicio('${id}')" class="text-gray-400 hover:text-red-500 transition p-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        window.eliminarServicio = function(id) { 
            if(document.querySelectorAll('.service-row').length > 1) { 
                document.getElementById(`row-${id}`).remove(); 
                calcularTotal(); 
            } else {
                alert("Debes mantener al menos un servicio en la lista.");
            }
        }

        // Activa/Desactiva el campo "Zona" dependiendo del tratamiento
        window.checkZone = function(select) {
            const input = select.closest('.service-row').querySelector('.s-zone');
            if(!select.value.includes('Fibroblast') && !select.value.includes('Otro')) { 
                input.value = ''; 
                input.disabled = true; 
                input.style.opacity = '0.5'; 
            } else { 
                input.disabled = false; 
                input.style.opacity = '1'; 
            }
        }

        // --- CÁLCULOS MATEMÁTICOS ---
        window.setPromo = function(pct) { 
            document.getElementById('promo_pct').value = pct; 
            calcularTotal(); 
        }
        
        window.resetDesc = function() { 
            document.getElementById('promo_pct').value = 0; 
            calcularTotal(); 
        }

        window.calcularTotal = function() {
            let sub = 0;
            // Sumar todas las filas
            document.querySelectorAll('.s-price').forEach(i => sub += parseFloat(i.value) || 0);
            
            // Calcular descuentos
            const pct = parseFloat(document.getElementById('promo_pct').value) || 0;
            const desc = sub * pct;
            const bono = parseFloat(document.getElementById('bono_extra').value) || 0;
            
            // Totales
            const total = sub - desc - bono;
            const abono = parseFloat(document.getElementById('abono').value) || 0;
            const pend = total - abono;

            // Mostrar en pantalla
            document.getElementById('subtotal').value = "$" + sub.toFixed(2);
            document.getElementById('descuento_txt').innerText = desc > 0 ? `- $${desc.toFixed(2)} (${pct*100}%)` : "";
            document.getElementById('lblTotal').innerText = "$" + total.toFixed(2);
            
            const elPend = document.getElementById('lblPendiente');
            elPend.innerText = "$" + pend.toFixed(2);
            
            // Colores condicionales
            if(pend <= 0.1 && total > 0) {
                elPend.innerText = "PAGADO";
                elPend.className = "text-2xl font-black text-green-500 font-mono tracking-tighter";
            } else {
                elPend.className = "text-2xl font-black text-rose-500 font-mono tracking-tighter";
            }
        }

        // --- CALCULAR EDAD ---
        window.calcularEdad = function() {
            const d = document.getElementById('dia_nac').value;
            const m = document.getElementById('mes_nac').value;
            const y = document.getElementById('anio_nac').value;
            
            if(d && m && y && y.length===4) { 
                const hoy = new Date();
                const cumple = new Date(y, m-1, d); 
                let edad = hoy.getFullYear() - cumple.getFullYear(); 
                // Ajuste si aún no ha cumplido años este mes
                if(hoy < new Date(hoy.getFullYear(), m-1, d)) {
                    edad--; 
                }
                document.getElementById('edad').value = edad + " años"; 
            }
        }

        // --- GUARDAR EN BASE DE DATOS (CREATE) ---
        document.getElementById('btnSave').addEventListener('click', async () => {
            const btn = document.getElementById('btnSave');
            const nombre = document.getElementById('nombre').value;
            const folio = document.getElementById('folioDisplay').innerText;
            const legal = document.getElementById('check_legal').checked;

            if(!nombre) return alert("⚠️ Error: Falta el Nombre del Paciente");
            if(!legal) return alert("⚠️ Error: Debes aceptar los Términos Legales");

            // Recopilar la lista de servicios
            let lista = [];
            document.querySelectorAll('.service-row').forEach(r => {
                lista.push({ 
                    tipo: r.querySelector('.s-type').value, 
                    zona: r.querySelector('.s-zone').value, 
                    precio: r.querySelector('.s-price').value 
                });
            });

            // Animación de carga en el botón
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GUARDANDO...';
            btn.disabled = true;

            try {
                // Enviar a Firebase
                await addDoc(collection(db, colName), {
                    folio: folio,
                    paciente: { 
                        nombre: nombre, 
                        cedula: document.getElementById('cedula').value, 
                        telefono: document.getElementById('telefono').value, 
                        edad: document.getElementById('edad').value, 
                        ocupacion: document.getElementById('ocupacion').value, 
                        direccion: document.getElementById('direccion').value 
                    },
                    servicios: lista,
                    finanzas: { 
                        subtotal: document.getElementById('subtotal').value, 
                        total: document.getElementById('lblTotal').innerText, 
                        abono: document.getElementById('abono').value, 
                        pendiente: document.getElementById('lblPendiente').innerText 
                    },
                    fecha: Timestamp.now()
                });
                
                alert("✅ FICHA GUARDADA EXITOSAMENTE");
                btn.innerHTML = '<i class="fas fa-check"></i> LISTO';
                btn.classList.add('bg-green-600');
                
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- CARGAR BASE DE DATOS (READ) ---
        window.loadData = async () => {
            const tb = document.getElementById('tableBody');
            const loader = document.getElementById('loader');
            
            tb.innerHTML = '';
            loader.classList.remove('hidden');
            
            // Consultar Firebase ordenado por fecha
            const snap = await getDocs(query(collection(db, colName), orderBy("fecha", "desc")));
            
            loader.classList.add('hidden');
            
            snap.forEach(doc => {
                const d = doc.data();
                // Renderizar fila en la tabla
                tb.innerHTML += `
                    <tr class="border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700 transition">
                        <td class="p-3 text-brand-main font-bold font-mono">${d.folio || '--'}</td>
                        <td class="p-3 dark:text-gray-300">${d.fecha.toDate().toLocaleDateString()}</td>
                        <td class="p-3 font-bold dark:text-white">${d.paciente.nombre}</td>
                        <td class="p-3 text-right font-mono font-bold dark:text-gray-300">${d.finanzas.total}</td>
                        <td class="p-3 text-center">
                            ${d.finanzas.pendiente.includes('PAGADO') 
                                ? '<span class="text-green-500 font-bold">OK</span>' 
                                : '<span class="text-rose-500 font-bold">DEBE</span>'}
                        </td>
                    </tr>`;
            });
        }

        // --- GENERAR PDF "FLASH" (TRUCO MODO OSCURO) ---
        document.getElementById('btnPdf').addEventListener('click', () => {
            const el = document.getElementById('viewForm');
            const controls = document.querySelectorAll('.no-print, .btn-remove');
            const wasDark = document.documentElement.classList.contains('dark');
            
            // 1. Apagar Modo Oscuro temporalmente (para que salga blanco el papel)
            if(wasDark) {
                document.documentElement.classList.remove('dark');
            }
            
            // 2. Ocultar botones
            controls.forEach(e => e.style.display = 'none');

            // 3. Generar PDF
            html2pdf().set({ 
                margin: 0, 
                filename: `Ficha_${document.getElementById('folioDisplay').innerText}.pdf`, 
                image: { type: 'jpeg', quality: 1 }, 
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            }).from(el).save().then(() => {
                
                // 4. Restaurar todo como estaba
                controls.forEach(e => e.style.display = '');
                if(wasDark) {
                    document.documentElement.classList.add('dark');
                }
            });
        });

    </script>
</body>
</html>
