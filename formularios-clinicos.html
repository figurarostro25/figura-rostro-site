<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Formularios Cl√≠nicos | Figura Rostro KG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> 
  <style>
    :root{
      --bg:#f5f0ff;
      --card:#ffffff;
      --brand:#5b2580;
      --brand-soft:#8a4cc4;
      --text:#1f1230;
      --border:#e0d2f5;
      --danger:#d93025;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:var(--bg);
      color:var(--text);
      overscroll-behavior: none; /* Evita rebote en mac/ios */
    }

    .page{
      max-width:1100px;
      margin:0 auto;
      padding:24px 16px 48px;
    }

    header{ text-align:center; margin-bottom:24px; }
    header h1{ margin:8px 0 4px; font-size:1.8rem; color:var(--brand); }
    header p{ margin:0; font-size:0.95rem; color:#5b5470; }

    /* TABS */
    .tabs{ display:flex; gap:8px; margin:24px 0 16px; justify-content:center; flex-wrap:wrap; }
    .tab-btn{
      border:1px solid var(--brand-soft); background:#fff; color:var(--brand);
      padding:8px 24px; border-radius:999px; font-size:0.95rem; font-weight: 500;
      cursor:pointer; transition:.2s;
    }
    .tab-btn.active{ background:var(--brand); color:#fff; box-shadow: 0 4px 12px rgba(91, 37, 128, 0.3); }

    /* FORM STRUCTURE */
    .forms-wrapper{
      background:var(--card); border-radius:16px; border:1px solid var(--border);
      padding:24px; box-shadow:0 10px 25px rgba(43,7,88,.07);
    }
    form{ display:none; animation: fadeIn 0.4s ease; }
    form.active{ display:block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    h2{ font-size:1.4rem; margin:0 0 12px; color:var(--brand); border-bottom: 2px solid var(--border); padding-bottom: 10px; }
    h3{ font-size:1.1rem; margin:24px 0 10px; color:var(--brand-soft); font-weight: 600; }
    label{ font-size:0.9rem; display:block; margin-bottom:5px; font-weight:500; color: #333; }

    /* INPUTS */
    .field-row{ display:flex; gap:16px; flex-wrap:wrap; }
    .field{ flex:1 1 200px; margin-bottom:12px; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border);
      font-size:0.95rem; background: #fcfaff;
    }
    textarea{ min-height:80px; resize:vertical; }

    /* CHECKBOXES */
    .check-group{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:8px 12px; margin-bottom:12px; background: #fafafa; padding: 10px; border-radius: 8px;
    }
    .check-item{ display:flex; align-items:flex-start; gap:8px; cursor: pointer; font-size:0.9rem;}
    .check-item input{ margin-top:3px; accent-color: var(--brand); }

    /* SIGNATURE PAD (√Årea de Firma) */
    .signature-wrapper {
      border: 2px dashed var(--brand-soft);
      background: #fff;
      border-radius: 12px;
      position: relative;
      margin-top: 10px;
      touch-action: none; /* CR√çTICO: Evita scroll al firmar */
    }
    
    canvas {
      width: 100%;
      height: 200px;
      display: block;
      border-radius: 12px;
      cursor: crosshair;
    }

    .sig-controls {
      display: flex;
      justify-content: flex-end;
      padding: 5px;
      background: #f0f0f0;
      border-radius: 0 0 12px 12px;
      border-top: 1px solid var(--border);
    }

    .btn-clear {
      background: #fff; border: 1px solid #ccc; color: #555;
      font-size: 0.8rem; padding: 4px 12px; border-radius: 4px; cursor: pointer;
    }

    /* CONSENT & ACTIONS */
    .consent-box{ margin-top:20px; padding:16px; border-radius:12px; background:#fdfaff; border:1px solid var(--border); font-size:0.85rem; line-height:1.5; }
    .consent-title{ font-weight:700; color:var(--brand); font-size: 1rem; }
    .consent-list{ padding-left:18px; margin:8px 0; }
    
    .actions{ display:flex; flex-wrap:wrap; gap:12px; margin-top:24px; padding-top: 20px; border-top: 1px solid var(--border); }
    .btn{ border:none; border-radius:999px; padding:12px 24px; font-size:0.95rem; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; transition: transform 0.1s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary{ background:var(--brand); color:#fff; box-shadow: 0 4px 10px rgba(91, 37, 128, 0.2); }
    .btn-ghost{ background:#fff; color:var(--brand); border:1px solid var(--brand-soft); }

    small{ font-size:0.75rem; color:#7b6d92; display: block; margin-top: 8px; }

    @media (max-width:600px){ .forms-wrapper{ padding:16px; } }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Formularios Cl√≠nicos ‚Äì Figura Rostro KG</h1>
      <p>Llenar en tablet y firmar digitalmente.</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-target="facial-form">Ficha Facial</button>
      <button class="tab-btn" data-target="corporal-form">Ficha Corporal</button>
    </div>

    <div class="forms-wrapper">
      
      <form id="facial-form" class="active" action="https://formsubmit.co/figurarostro25@gmail.com" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_next" value="https://figurarostro.life">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_subject" value="Ficha FACIAL Firmada">
        
        <input type="hidden" name="signature_data" id="facial_sig_data">

        <h2>Ficha T√©cnica Facial</h2>

        <h3>1. Datos Personales</h3>
        <div class="field-row">
          <div class="field"><label>Nombre completo</label><input type="text" name="facial_nombre" required></div>
          <div class="field"><label>Edad</label><input type="number" name="facial_edad"></div>
          <div class="field"><label>Sexo</label><select name="facial_sexo"><option value="">Seleccionar...</option><option value="F">F</option><option value="M">M</option></select></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Tel√©fono</label><input type="tel" name="facial_telefono"></div>
          <div class="field"><label>Fecha</label><input type="date" name="facial_fecha" id="date-facial"></div>
        </div>

        <h3>2. Evaluaci√≥n (Resumida)</h3>
        <div class="field"><label>Biotipo / Condici√≥n</label><input type="text" name="facial_biotipo" placeholder="Grasa, mixta, acn√©..."></div>
        <div class="field"><label>Alergias / Medicamentos</label><input type="text" name="facial_alergias"></div>
        
        <div class="section-divider"></div>

        <div class="consent-box">
          <div class="consent-title">Consentimiento y Firma</div>
          <p>Declaro que la informaci√≥n es correcta y autorizo el tratamiento facial.</p>
          
          <label style="margin-top:15px; display:block; font-weight:600; color:#5b2580;">Firma del Cliente (Dibuje aqu√≠):</label>
          <div class="signature-wrapper">
            <canvas id="sig-canvas-facial"></canvas>
            <div class="sig-controls">
              <button type="button" class="btn-clear" onclick="clearSignature('facial')">Borrar Firma</button>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary" onclick="prepareSignature('facial')">Enviar Ficha</button>
          <button type="button" class="btn btn-ghost" onclick="generarImprimible('facial')">üìÑ Imprimir PDF con Firma</button>
        </div>
      </form>

      <form id="corporal-form" action="https://formsubmit.co/figurarostro25@gmail.com" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_next" value="https://figurarostro.life">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_subject" value="Ficha CORPORAL Firmada">
        <input type="hidden" name="signature_data" id="corp_sig_data">

        <h2>Ficha T√©cnica Corporal</h2>

        <h3>1. Datos Personales</h3>
        <div class="field-row">
          <div class="field"><label>Nombre completo</label><input type="text" name="corp_nombre" required></div>
          <div class="field"><label>Edad</label><input type="number" name="corp_edad"></div>
          <div class="field"><label>Sexo</label><select name="corp_sexo"><option value="">Seleccionar...</option><option value="F">F</option><option value="M">M</option></select></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Tel√©fono</label><input type="tel" name="corp_telefono"></div>
          <div class="field"><label>Fecha</label><input type="date" name="corp_fecha" id="date-corp"></div>
        </div>

        <h3>2. Seguridad Cl√≠nica (Obligatorio)</h3>
        <div class="check-group">
          <label class="check-item"><input type="checkbox" name="corp_medico[]" value="Marcapasos"><span>Marcapasos</span></label>
          <label class="check-item"><input type="checkbox" name="corp_medico[]" value="Metal"><span>Implantes Met√°licos</span></label>
          <label class="check-item"><input type="checkbox" name="corp_medico[]" value="DIU"><span>DIU / T de Cobre</span></label>
          <label class="check-item"><input type="checkbox" name="corp_medico[]" value="Embarazo"><span>Embarazo</span></label>
        </div>
        <div class="field"><label>Alergias / Cirug√≠as</label><input type="text" name="corp_alergias"></div>

        <h3>3. Evaluaci√≥n</h3>
        <div class="field"><label>Zonas a tratar</label><textarea name="corp_zonas"></textarea></div>

        <div class="section-divider"></div>

        <div class="consent-box">
          <div class="consent-title">Consentimiento y Firma</div>
          <p>Confirmo que he informado sobre implantes o condiciones m√©dicas y acepto el tratamiento corporal.</p>
          
          <label style="margin-top:15px; display:block; font-weight:600; color:#5b2580;">Firma del Cliente (Dibuje aqu√≠):</label>
          <div class="signature-wrapper">
            <canvas id="sig-canvas-corp"></canvas>
            <div class="sig-controls">
              <button type="button" class="btn-clear" onclick="clearSignature('corp')">Borrar Firma</button>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary" onclick="prepareSignature('corp')">Enviar Ficha</button>
          <button type="button" class="btn btn-ghost" onclick="generarImprimible('corporal')">üìÑ Imprimir PDF con Firma</button>
        </div>
      </form>

    </div>
  </div>

  <script>
    // === 1. CONFIGURACI√ìN B√ÅSICA ===
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date-facial').value = today;
      document.getElementById('date-corp').value = today;
      
      // Iniciar los Canvas
      initCanvas('sig-canvas-facial');
      initCanvas('sig-canvas-corp');
    });

    // Pesta√±as
    const tabs = document.querySelectorAll('.tab-btn');
    const forms = document.querySelectorAll('form');
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        forms.forEach(f => f.classList.remove('active'));
        document.getElementById(btn.dataset.target).classList.add('active');
        // Redimensionar canvas al cambiar de tab para evitar errores visuales
        resizeCanvas(document.getElementById('sig-canvas-facial'));
        resizeCanvas(document.getElementById('sig-canvas-corp'));
      });
    });

    // === 2. L√ìGICA DE FIRMA DIGITAL (CANVAS) ===
    function initCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      let drawing = false;

      // Ajuste de resoluci√≥n
      resizeCanvas(canvas);
      window.addEventListener('resize', () => resizeCanvas(canvas));

      // Eventos Mouse (PC)
      canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(getX(e, canvas), getY(e, canvas)); });
      canvas.addEventListener('mousemove', (e) => { if (drawing) draw(e, canvas, ctx); });
      canvas.addEventListener('mouseup', () => { drawing = false; });
      canvas.addEventListener('mouseout', () => { drawing = false; });

      // Eventos Touch (Tablet/Celular)
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Evita scroll
        drawing = true;
        ctx.beginPath();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
      }, {passive: false});

      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault(); // Evita scroll
        if (!drawing) return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
        ctx.stroke();
      }, {passive: false});

      canvas.addEventListener('touchend', () => { drawing = false; });

      // Estilo de l√≠nea
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
    }

    function draw(e, canvas, ctx) {
      ctx.lineTo(getX(e, canvas), getY(e, canvas));
      ctx.stroke();
    }

    function getX(e, canvas) { return e.offsetX; }
    function getY(e, canvas) { return e.offsetY; }

    function resizeCanvas(canvas) {
      // Guarda el contenido actual si quisieras persistirlo, pero aqu√≠ limpia al redimensionar
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext('2d').scale(ratio, ratio);
    }

    function clearSignature(type) {
      const id = type === 'facial' ? 'sig-canvas-facial' : 'sig-canvas-corp';
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Borrar todo
      
      // Reiniciar escala despu√©s de borrar
      resizeCanvas(canvas);
    }

    // Antes de enviar, guardar firma en input hidden (opcional)
    function prepareSignature(type) {
      const canvasId = type === 'facial' ? 'sig-canvas-facial' : 'sig-canvas-corp';
      const inputId = type === 'facial' ? 'facial_sig_data' : 'corp_sig_data';
      const canvas = document.getElementById(canvasId);
      const dataUrl = canvas.toDataURL('image/png');
      document.getElementById(inputId).value = dataUrl;
    }

    // === 3. GENERAR PDF CON FIRMA ===
    function generarImprimible(tipo) {
      const form = document.getElementById(tipo + '-form');
      const data = new FormData(form);
      
      // Obtener imagen de la firma
      const canvasId = tipo === 'facial' ? 'sig-canvas-facial' : 'sig-canvas-corp';
      const canvas = document.getElementById(canvasId);
      const signatureImage = canvas.toDataURL('image/png');

      let win = window.open('', '_blank');
      let titulo = tipo === 'facial' ? 'Ficha Cl√≠nica Facial' : 'Ficha Cl√≠nica Corporal';
      let nombre = tipo === 'facial' ? data.get('facial_nombre') : data.get('corp_nombre');
      
      let html = `
        <html><head><title>${titulo} - ${nombre}</title>
        <style>
          body{ font-family: sans-serif; padding: 40px; color: #333; max-width:800px; margin:0 auto; }
          h1{ color: #5b2580; border-bottom: 2px solid #5b2580; margin-bottom: 20px; }
          .data-box{ margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
          strong{ color: #5b2580; }
          .firma-img{ max-width: 200px; border-bottom: 1px solid #000; padding-bottom: 5px; }
          .consent-text{ font-size: 11px; color: #555; margin-top: 30px; text-align: justify; }
          .footer-firma{ margin-top: 40px; display: flex; justify-content: space-between; align-items: flex-end; }
        </style>
        </head><body>
          <h1>${titulo}</h1>
          <p class="data-box"><strong>Cliente:</strong> ${nombre}</p>
          <p class="data-box"><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
      `;

      if(tipo === 'facial'){
        html += `
          <p class="data-box"><strong>Edad:</strong> ${data.get('facial_edad')} | <strong>Sexo:</strong> ${data.get('facial_sexo')}</p>
          <p class="data-box"><strong>Tel√©fono:</strong> ${data.get('facial_telefono')}</p>
          <br>
          <h3>Evaluaci√≥n</h3>
          <p><strong>Biotipo:</strong> ${data.get('facial_biotipo')}</p>
          <p><strong>Alergias:</strong> ${data.get('facial_alergias')}</p>
        `;
      } else {
         let medicos = data.getAll('corp_medico[]').join(', ');
         html += `
          <p class="data-box"><strong>Edad:</strong> ${data.get('corp_edad')} | <strong>Sexo:</strong> ${data.get('corp_sexo')}</p>
          <br>
          <h3>Datos M√©dicos</h3>
          <p><strong>Condiciones:</strong> ${medicos || 'Ninguna marcada'}</p>
          <p><strong>Alergias/Cirug√≠as:</strong> ${data.get('corp_alergias')}</p>
          <p><strong>Zonas a tratar:</strong> ${data.get('corp_zonas')}</p>
         `;
      }

      html += `
          <div class="consent-text">
            Por medio de la presente, confirmo que los datos proporcionados son reales y autorizo el procedimiento est√©tico, exonerando de responsabilidad por omisi√≥n de informaci√≥n m√©dica.
          </div>

          <div class="footer-firma">
            <div style="text-align:center;">
              <img src="${signatureImage}" class="firma-img" alt="Firma del Cliente"><br>
              Firma del Cliente
            </div>
            <div style="text-align:center;">
              <div style="width:200px; border-bottom:1px solid #000; height:1px; margin-bottom:5px;"></div>
              Firma Especialista
            </div>
          </div>
        </body></html>
      `;

      win.document.write(html);
      win.document.close();
      win.focus();
      // win.print(); // Descomenta si quieres que imprima autom√°tico
    }
  </script>
</body>
</html>
