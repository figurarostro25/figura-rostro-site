<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Formularios Clínicos | Figura Rostro KG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  
  <style>
    /* ESTILOS VISUALES (IGUAL QUE ANTES) */
    :root{ --bg:#f5f0ff; --card:#ffffff; --brand:#5b2580; --brand-soft:#8a4cc4; --text:#1f1230; --border:#e0d2f5; --danger:#d93025; }
    *{box-sizing:border-box;}
    body{ margin:0; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:var(--bg); color:var(--text); overscroll-behavior: none; }
    .page{ max-width:1100px; margin:0 auto; padding:20px 16px 50px; }
    header{ text-align:center; margin-bottom:20px; }
    header h1{ margin:8px 0 4px; font-size:1.6rem; color:var(--brand); }
    header p{ margin:0; font-size:0.9rem; color:#5b5470; }
    
    /* TABS */
    .tabs{ display:flex; gap:10px; margin:20px 0 16px; justify-content:center; }
    .tab-btn{ border:1px solid var(--brand-soft); background:#fff; color:var(--brand); padding:10px 24px; border-radius:999px; font-size:1rem; font-weight: 500; cursor:pointer; transition:.2s; }
    .tab-btn.active{ background:var(--brand); color:#fff; box-shadow: 0 4px 12px rgba(91, 37, 128, 0.3); }

    /* FORM WRAPPER */
    .forms-wrapper{ background:var(--card); border-radius:16px; border:1px solid var(--border); padding:20px; box-shadow:0 8px 20px rgba(43,7,88,.07); position: relative; }
    form{ display:none; }
    form.active{ display:block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* TYPOGRAPHY & INPUTS */
    h2{ font-size:1.3rem; margin:0 0 15px; color:var(--brand); border-bottom: 2px solid var(--border); padding-bottom: 8px; }
    h3{ font-size:1.05rem; margin:24px 0 8px; color:var(--brand-soft); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    label{ font-size:0.9rem; display:block; margin-bottom:4px; font-weight:600; color: #444; }
    .field-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .field{ flex:1 1 180px; margin-bottom:10px; }
    input, select, textarea{ width:100%; padding:8px 10px; border-radius:6px; border:1px solid var(--border); font-size:0.95rem; background: #fcfaff; }
    textarea{ min-height:60px; resize:vertical; }
    
    /* CHECKBOXES */
    .check-group{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:6px 10px; margin-bottom:12px; background: #faf8fd; padding: 10px; border-radius: 8px; border: 1px solid #f0e6fa; }
    .check-item{ display:flex; align-items:flex-start; gap:8px; cursor: pointer; font-size:0.85rem; font-weight: 400; color: #333; }
    .check-item input{ margin-top:3px; accent-color: var(--brand); transform: scale(1.1); }

    /* FIRMA */
    .section-divider{ border-top:1px dashed var(--border); margin:24px 0; }
    .signature-container { margin-top: 15px; border: 2px dashed var(--brand-soft); background: #fff; border-radius: 8px; position: relative; touch-action: none; }
    canvas { width: 100%; height: 130px; display: block; cursor: crosshair; }
    .sig-footer { background: #f4f4f4; border-top: 1px solid #ddd; padding: 4px 10px; display: flex; justify-content: flex-end; border-radius: 0 0 8px 8px; }
    .btn-small { background: #fff; border: 1px solid #999; font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; cursor: pointer; color: #555; }

    /* CONSENTIMIENTO & BOTONES */
    .consent-box{ background:#f8f5fc; padding:15px; border-radius:10px; border:1px solid var(--border); font-size:0.85rem; line-height:1.4; color: #444; }
    .consent-title{ color: var(--brand); font-weight: 700; margin-bottom: 5px; }
    .consent-list{ padding-left: 15px; margin: 5px 0; }
    .actions{ display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }
    .btn{ border:none; border-radius:999px; padding:12px 24px; font-size:0.95rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; flex: 1; justify-content: center; transition: 0.2s; }
    .btn-primary{ background:var(--brand); color:#fff; }
    .btn-primary:disabled { background: #aaa; cursor: not-allowed; }
    .btn-ghost{ background:#fff; color:var(--brand); border:1px solid var(--brand); }

    /* LOADER (Pantalla de carga al enviar) */
    .loading-overlay {
      position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9);
      display:none; justify-content:center; align-items:center; z-index: 10; border-radius: 16px; flex-direction: column;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--brand); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (max-width:600px){ .forms-wrapper{ padding:12px; } .btn{ flex: 100%; } }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Formularios Clínicos – Figura Rostro KG</h1>
      <p>Historial Digital + Consentimiento</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-target="facial-form">Ficha Facial</button>
      <button class="tab-btn" data-target="corporal-form">Ficha Corporal</button>
    </div>

    <div class="forms-wrapper">
      
      <div class="loading-overlay" id="loader">
        <div class="loading-spinner"></div>
        <p style="margin-top:10px; font-weight:600; color:#5b2580">Enviando y adjuntando firma...</p>
      </div>

      <form id="facial-form" class="active">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_template" value="table"> <input type="hidden" name="_subject" value="Nueva Historia Clínica: FACIAL">

        <h2>Ficha Técnica Facial</h2>

        <h3>1. Datos del Cliente</h3>
        <div class="field-row">
          <div class="field"><label>Nombre completo</label><input type="text" name="Nombre" required></div>
          <div class="field"><label>Edad</label><input type="number" name="Edad"></div>
          <div class="field"><label>Sexo</label><input type="text" name="Sexo" placeholder="F / M"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Teléfono</label><input type="tel" name="Telefono"></div>
          <div class="field"><label>Correo</label><input type="email" name="Correo"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Dirección</label><input type="text" name="Direccion"></div>
          <div class="field"><label>Fecha</label><input type="date" name="Fecha" id="date-facial"></div>
        </div>

        <h3>2. Tratamiento Solicitado</h3>
        <label>Limpiezas y Peelings</label>
        <div class="check-group">
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Limpieza Profunda"> Limpieza Profunda</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Limpieza Premium"> Limpieza Premium</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Dermaplaning"> Dermaplaning</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Peeling Químico"> Peeling Químico</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Peeling Hollywood"> Peeling Hollywood</label>
        </div>

        <label>Rejuvenecimiento y Plasma Fibroblast</label>
        <div class="check-group">
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Fibroblast Párpados"> Fibroblast Párpados</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Fibroblast Ojeras"> Fibroblast Ojeras</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Fibroblast Orejas"> Fibroblast Orejas</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Fibroblast Cuello"> Fibroblast Cuello</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Fibroblast Abdomen"> Fibroblast Abdomen</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Otros Fibroblast"> Otros Fibroblast</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Alta Frecuencia"> Alta Frecuencia</label>
        </div>

        <label>Cejas, Pestañas y Labios</label>
        <div class="check-group">
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Diseño Cejas"> Diseño Cejas</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Micropigmentación"> Micropigmentación</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Lifting Pestañas"> Lifting Pestañas</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Hidralix Labios"> Hidralix Labios</label>
        </div>

        <h3>3. Evaluación Técnica</h3>
        <div class="field-row">
          <div class="field"><label>Tipo de Piel</label><input type="text" name="Tipo_Piel" placeholder="Grasa, Mixta, Seca..."></div>
          <div class="field"><label>Sensibilidad</label><select name="Sensibilidad"><option>Baja</option><option>Media</option><option>Alta</option></select></div>
        </div>
        <div class="field"><label>Condiciones Observadas</label><textarea name="Condiciones" placeholder="Acné, manchas, poros abiertos..."></textarea></div>

        <h3>4. Historial Médico</h3>
        <div class="field-row">
          <div class="field"><label>Alergias</label><input type="text" name="Alergias"></div>
          <div class="field"><label>Medicamentos</label><input type="text" name="Medicamentos"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Cirugías Recientes</label><input type="text" name="Cirugias"></div>
          <div class="field"><label>Tratamientos Previos</label><input type="text" name="Previos"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Tensión Arterial</label><input type="text" name="Tension"></div>
          <div class="field"><label>Frecuencia Cardíaca</label><input type="text" name="FC"></div>
        </div>

        <h3>5. Recomendación</h3>
        <div class="field"><textarea name="Recomendacion" placeholder="Protocolo a seguir..."></textarea></div>

        <div class="section-divider"></div>
        <div class="consent-box">
          <div class="consent-title">Consentimiento y Firma</div>
          <p>Confirmo que la información es verídica y autorizo el procedimiento.</p>
          <label style="margin-top:10px;">Firma del Cliente:</label>
          <div class="signature-container">
            <canvas id="canvas-facial"></canvas>
            <div class="sig-footer"><button type="button" class="btn-small" onclick="clearSig('facial')">Borrar</button></div>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-primary" onclick="submitForm('facial')">Guardar y Enviar al Correo</button>
          <button type="button" class="btn btn-ghost" onclick="printForm('facial')">Descargar PDF (Copia)</button>
        </div>
      </form>

      <form id="corporal-form">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_template" value="table">
        <input type="hidden" name="_subject" value="Nueva Historia Clínica: CORPORAL">

        <h2>Ficha Técnica Corporal</h2>

        <h3>1. Datos del Cliente</h3>
        <div class="field-row">
          <div class="field"><label>Nombre completo</label><input type="text" name="Nombre" required></div>
          <div class="field"><label>Edad</label><input type="number" name="Edad"></div>
          <div class="field"><label>Sexo</label><input type="text" name="Sexo" placeholder="F / M"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Teléfono</label><input type="tel" name="Telefono"></div>
          <div class="field"><label>Fecha</label><input type="date" name="Fecha" id="date-corp"></div>
        </div>

        <h3>2. Tratamientos Solicitados</h3>
        <label>Reducción y Moldeamiento</label>
        <div class="check-group">
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Masaje Reductor"> Masaje Reductor</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Masaje Moldeador"> Masaje Moldeador</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Maderoterapia"> Maderoterapia</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Anticelulitis"> Anticelulitis</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Aparatologia"> Aparatología</label>
        </div>
        <label>Drenaje y Relax</label>
        <div class="check-group">
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Drenaje Linfatico"> Drenaje Linfático</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Post-Operatorio"> Post-Operatorio</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Masaje Relajante"> Masaje Relajante</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Descontracturante"> Descontracturante</label>
        </div>
        <label>Depilación</label>
        <div class="check-group">
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Cera Cuerpo"> Cera Cuerpo</label>
          <label class="check-item"><input type="checkbox" name="Servicios[]" value="Cera Intima"> Cera Íntima</label>
        </div>

        <h3>3. Seguridad y Salud</h3>
        <p style="font-size:0.85rem; color:#d93025; margin-bottom:5px;">*Obligatorio: Marque si aplica.</p>
        <div class="check-group" style="background:#fff0f0; border-color:#fadbd8;">
          <label class="check-item"><input type="checkbox" name="Alerta_Medica[]" value="Marcapasos"> <b>Marcapasos</b></label>
          <label class="check-item"><input type="checkbox" name="Alerta_Medica[]" value="Metales"> <b>Implantes Metálicos</b></label>
          <label class="check-item"><input type="checkbox" name="Alerta_Medica[]" value="DIU"> <b>DIU (T de Cobre)</b></label>
          <label class="check-item"><input type="checkbox" name="Alerta_Medica[]" value="Embarazo"> <b>Embarazo</b></label>
          <label class="check-item"><input type="checkbox" name="Alerta_Medica[]" value="Hipertension"> Hipertensión</label>
        </div>

        <div class="field-row">
          <div class="field"><label>Agua</label><select name="Agua"><option>Menos de 1L</option><option>1-2L</option><option>+2L</option></select></div>
          <div class="field"><label>Actividad</label><select name="Actividad"><option>Sedentario</option><option>Moderada</option><option>Intensa</option></select></div>
        </div>

        <h3>4. Historial Médico</h3>
        <div class="field-row">
          <div class="field"><label>Alergias</label><input type="text" name="Alergias"></div>
          <div class="field"><label>Cirugías</label><input type="text" name="Cirugias"></div>
        </div>
        <div class="field"><label>Medicamentos</label><input type="text" name="Medicamentos"></div>

        <h3>5. Evaluación y Protocolo</h3>
        <div class="field"><label>Zonas a Tratar</label><textarea name="Zonas_Tratar"></textarea></div>
        <div class="field"><label>Diagnóstico Estético</label><textarea name="Diagnostico"></textarea></div>
        <div class="field"><label>Protocolo Recomendado</label><textarea name="Protocolo"></textarea></div>

        <div class="section-divider"></div>
        <div class="consent-box">
          <div class="consent-title">Consentimiento y Firma</div>
          <p>Confirmo que he informado sobre mis condiciones de salud y acepto el tratamiento.</p>
          <label style="margin-top:10px;">Firma del Cliente:</label>
          <div class="signature-container">
            <canvas id="canvas-corp"></canvas>
            <div class="sig-footer"><button type="button" class="btn-small" onclick="clearSig('corp')">Borrar</button></div>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-primary" onclick="submitForm('corporal')">Guardar y Enviar al Correo</button>
          <button type="button" class="btn btn-ghost" onclick="printForm('corporal')">Descargar PDF (Copia)</button>
        </div>
      </form>

    </div>
  </div>

  <script>
    // --- 1. CONFIGURACIÓN INICIAL ---
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date-facial').value = today;
    document.getElementById('date-corp').value = today;

    const tabs = document.querySelectorAll('.tab-btn');
    const forms = document.querySelectorAll('form');

    // Cambiar Pestañas
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        forms.forEach(f => f.classList.remove('active'));
        const targetId = btn.dataset.target;
        document.getElementById(targetId).classList.add('active');
        resizeCanvas(document.getElementById(targetId === 'facial-form' ? 'canvas-facial' : 'canvas-corp'));
      });
    });

    // --- 2. GESTIÓN DE CANVAS (FIRMA) ---
    function initCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      let drawing = false;

      const resize = () => {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
      };
      window.addEventListener('resize', resize);
      setTimeout(resize, 200);

      // Mouse
      const startDraw = (e) => { drawing = true; ctx.beginPath(); draw(e); };
      const endDraw = () => { drawing = false; ctx.beginPath(); };
      const draw = (e) => {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
      };

      canvas.addEventListener('mousedown', startDraw);
      canvas.addEventListener('mouseup', endDraw);
      canvas.addEventListener('mousemove', draw);
      // Touch
      canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); }, {passive: false});
      canvas.addEventListener('touchend', endDraw);
      canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, {passive: false});
    }

    initCanvas('canvas-facial');
    initCanvas('canvas-corp');

    function resizeCanvas(canvas){
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    }
    function clearSig(type) {
      const c = document.getElementById(type === 'facial' ? 'canvas-facial' : 'canvas-corp');
      c.getContext('2d').clearRect(0, 0, c.width, c.height);
    }

    // --- 3. ENVÍO INTELIGENTE (ESTE ES EL TRUCO PARA ADJUNTAR LA FIRMA) ---
    function submitForm(type) {
      const form = document.getElementById(type + '-form');
      const canvas = document.getElementById(type === 'facial' ? 'canvas-facial' : 'canvas-corp');
      
      // Mostrar Loader
      const loader = document.getElementById('loader');
      loader.style.display = 'flex';

      // Convertir Canvas a BLOB (Archivo de imagen real)
      canvas.toBlob(function(blob) {
        const formData = new FormData(form);
        
        // Agregar la firma como archivo adjunto
        // Si el canvas está vacío, el blob puede ser transparente, pero se envía igual.
        if(blob){
          formData.append('Firma_Cliente', blob, 'firma_paciente.png');
        }

        // Enviar a FormSubmit usando Fetch (sin recargar página)
        fetch("https://formsubmit.co/figurarostro25@gmail.com", {
            method: "POST",
            body: formData
        })
        .then(response => {
            loader.style.display = 'none';
            if (response.ok) {
                alert("¡Historia Clínica enviada con éxito! Revisa tu correo.");
                window.location.href = "https://figurarostro.life"; // Redirigir al inicio
            } else {
                alert("Hubo un error al enviar. Intenta de nuevo.");
            }
        })
        .catch(error => {
            loader.style.display = 'none';
            alert("Error de conexión.");
            console.error(error);
        });
      }, 'image/png');
    }

    // --- 4. GENERAR PDF PARA GUARDAR LOCALMENTE (OPCIONAL) ---
    function printForm(type) {
      // Esta función genera la vista de impresión por si quieren guardarlo en carpeta del dispositivo
      const form = document.getElementById(type + '-form');
      const data = new FormData(form);
      const canvas = document.getElementById(type === 'facial' ? 'canvas-facial' : 'canvas-corp');
      const sigImg = canvas.toDataURL('image/png');
      
      let win = window.open('', '_blank');
      let title = type === 'facial' ? 'Ficha Facial' : 'Ficha Corporal';
      let nombre = data.get('Nombre') || 'Cliente';

      // Construir HTML simple para imprimir
      let content = `
        <html><head><title>${title} - ${nombre}</title>
        <style>body{font-family:sans-serif; padding:20px;} .row{display:flex;justify-content:space-between;border-bottom:1px solid #ddd;padding:5px 0;} strong{color:#5b2580}</style>
        </head><body>
        <h1>${title} - Figura Rostro</h1>
        <div class="row"><strong>Cliente:</strong> ${nombre}</div>
        <div class="row"><strong>Fecha:</strong> ${data.get('Fecha')}</div>
        <div class="row"><strong>Servicios:</strong> ${data.getAll('Servicios[]').join(', ')}</div>
        <p><i>Nota: Para ver el detalle completo, revise el correo enviado a la base de datos.</i></p>
        <br>
        <strong>Firma del Cliente:</strong><br>
        <img src="${sigImg}" style="max-width:200px; border:1px solid #ccc;">
        </body></html>
      `;
      win.document.write(content);
      win.document.close();
      setTimeout(()=> win.print(), 500);
    }
  </script>
</body>
</html>
